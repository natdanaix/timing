<!DOCTYPE html>
<html lang="th">
<head>
  
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Football Time Tuner – Auto Play</title>
<link rel="icon" type="image/png" href="https://thaileague.co.th/assets/img/thaileague_meta_logo.jpeg">
<style>
:root {
  /* Football field colors */
  --field-green: #2d7d32;
  --field-light: #4caf50;
  --field-dark: #1b5e20;
  --grass-light: #66bb6a;
  --grass-dark: #388e3c;
  
  /* UI colors */
  --bg: linear-gradient(135deg, #000000 0%, #1a1a1a 50%, #000000 100%);
  --panel: rgba(255, 255, 255, 0.1);
  --panel-border: rgba(255, 255, 255, 0.2);
  --line: #ffffff;
  --tick: rgba(255, 255, 255, 0.6);
  
  /* Card theme colors */
  --card-halftime-bg: linear-gradient(135deg, rgba(33, 150, 243, 0.2), rgba(244, 67, 54, 0.15));
  --card-halftime-border: rgba(33, 150, 243, 0.4);
  
  --card-tuner-bg: linear-gradient(135deg, rgba(255, 152, 0, 0.15), rgba(255, 193, 7, 0.1));
  --card-tuner-border: rgba(255, 152, 0, 0.3);
  
  /* Half colors */
  --half1: #4caf50;
  --half2: #8bc34a;
  --et1: #ff9800;
  --et2: #f44336;
  --bound: #ffeb3b;
  --fg: #ffffff;
  
  /* Shadows */
  --shadow-primary: 0 8px 32px rgba(0, 0, 0, 0.3);
  --shadow-secondary: 0 4px 16px rgba(0, 0, 0, 0.2);
}

* {
  box-sizing: border-box;
}

body {
  margin: 0;
  background: var(--bg);
  color: var(--fg);
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  min-height: 100vh;
  position: relative;
  overflow-x: hidden;
}

/* Football field background */
.field-background {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: var(--bg);
  z-index: -1;
}

@keyframes grassSway {
  0%, 100% { opacity: 0.8; }
  50% { opacity: 1; }
}

h1 {
  margin: 18px 16px 6px;
  font-weight: 900;
  letter-spacing: 0.5px;
  font-size: clamp(24px, 5vw, 36px);
  text-align: center;
  text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.5);
  animation: titleGlow 3s ease-in-out infinite;
}

@keyframes titleGlow {
  0%, 100% { text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.5); }
  50% { text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.5), 0 0 20px rgba(255, 255, 255, 0.3); }
}

.card {
  background: var(--panel);
  border: 1px solid var(--panel-border);
  border-radius: 20px;
  padding: 16px;
  margin: 12px 16px;
  box-shadow: var(--shadow-primary);
  backdrop-filter: blur(10px);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.card:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-primary), 0 12px 40px rgba(0, 0, 0, 0.4);
}

/* Card variants with different colors */
.card-halftime {
  background: var(--card-halftime-bg);
  border-color: var(--card-halftime-border);
  box-shadow: 0 8px 32px rgba(33, 150, 243, 0.2);
}

.card-halftime:hover {
  box-shadow: 0 8px 32px rgba(33, 150, 243, 0.3), 0 12px 40px rgba(33, 150, 243, 0.2);
}

.card-tuner {
  background: var(--card-tuner-bg);
  border-color: var(--card-tuner-border);
  box-shadow: 0 8px 32px rgba(255, 152, 0, 0.2);
}

.card-tuner:hover {
  box-shadow: 0 8px 32px rgba(255, 152, 0, 0.3), 0 12px 40px rgba(255, 152, 0, 0.2);
}

/* Team inputs styles */
.card-teams {
  background: linear-gradient(135deg, rgba(76, 175, 80, 0.15), rgba(56, 142, 60, 0.1));
  border-color: rgba(76, 175, 80, 0.3);
  box-shadow: 0 8px 32px rgba(76, 175, 80, 0.2);
}

.card-teams:hover {
  box-shadow: 0 8px 32px rgba(76, 175, 80, 0.3), 0 12px 40px rgba(76, 175, 80, 0.2);
}

.team-inputs {
  display: flex;
  align-items: center;
  gap: 20px;
  flex-wrap: wrap;
  justify-content: center;
}

.team-input-group {
  flex: 1;
  min-width: 200px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.team-input-group label {
  font-weight: 900;
  color: #2e7d32;
  font-size: clamp(14px, 4vw, 16px);
  letter-spacing: 0.3px;
}

.team-input-group input {
  padding: 12px 16px;
  border: 2px solid rgba(76, 175, 80, 0.3);
  border-radius: 12px;
  background: rgba(255, 255, 255, 0.9);
  color: #2e7d32;
  font-size: clamp(14px, 4vw, 16px);
  font-weight: 700;
  text-align: center;
  transition: all 0.3s ease;
  backdrop-filter: blur(5px);
}

.team-input-group input:focus {
  outline: none;
  border-color: #4caf50;
  background: rgba(255, 255, 255, 1);
  box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2);
  transform: translateY(-1px);
}

.team-input-group input::placeholder {
  color: rgba(46, 125, 50, 0.6);
  font-weight: 500;
}

.vs-divider {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 60px;
  height: 60px;
  background: linear-gradient(135deg, #ff9800, #ffc107);
  border-radius: 50%;
  font-weight: 900;
  font-size: 18px;
  color: white;
  text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.3);
  box-shadow: 0 4px 16px rgba(255, 152, 0, 0.4);
  animation: vsGlow 3s ease-in-out infinite;
  flex-shrink: 0;
}

@keyframes vsGlow {
  0%, 100% { 
    box-shadow: 0 4px 16px rgba(255, 152, 0, 0.4);
    transform: scale(1);
  }
  50% { 
    box-shadow: 0 4px 20px rgba(255, 152, 0, 0.6), 0 0 30px rgba(255, 152, 0, 0.3);
    transform: scale(1.05);
  }
}

.row {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  align-items: center;
}

.group {
  display: flex;
  gap: 12px;
  align-items: center;
  justify-content: space-between;
  padding: 16px;
  border-radius: 16px;
  background: rgba(0, 0, 0, 0.2);
  border: 1px solid rgba(255, 255, 255, 0.1);
  flex: 1 1 320px;
  transition: all 0.3s ease;
}

.group:hover {
  background: rgba(0, 0, 0, 0.3);
  border-color: rgba(255, 255, 255, 0.2);
  transform: scale(1.02);
}

.g1 {
  border-color: rgba(33, 150, 243, 0.6);
  background: linear-gradient(135deg, rgba(33, 150, 243, 0.4), rgba(25, 118, 210, 0.3));
}

.g1:hover {
  border-color: rgba(33, 150, 243, 0.8);
  background: linear-gradient(135deg, rgba(33, 150, 243, 0.5), rgba(25, 118, 210, 0.4));
}

.g2 {
  border-color: rgba(244, 67, 54, 0.6);
  background: linear-gradient(135deg, rgba(244, 67, 54, 0.4), rgba(211, 47, 47, 0.3));
}

.g2:hover {
  border-color: rgba(244, 67, 54, 0.8);
  background: linear-gradient(135deg, rgba(244, 67, 54, 0.5), rgba(211, 47, 47, 0.4));
}

/* Half End Controls */
.half-end-controls {
  margin-top: 16px;
  padding-top: 16px;
  border-top: 1px solid rgba(255, 255, 255, 0.2);
  display: flex;
  gap: 20px;
  flex-wrap: wrap;
  justify-content: center;
}

.control-group {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  flex: 1;
  min-width: 200px;
}

.control-buttons {
  display: flex;
  gap: 8px;
  align-items: center;
  justify-content: center;
  width: 100%;
}

.end-half-btn {
  padding: 12px 20px;
  border-radius: 12px;
  border: 2px solid rgba(255, 255, 255, 0.3);
  background: linear-gradient(135deg, rgba(255, 152, 0, 0.2), rgba(255, 193, 7, 0.1));
  color: #ff9800;
  font-weight: 900;
  font-size: clamp(14px, 4vw, 16px);
  cursor: pointer;
  transition: all 0.3s ease;
  flex: 1;
  max-width: 160px;
}

.reset-btn {
  padding: 12px;
  border-radius: 50%;
  border: 2px solid rgba(244, 67, 54, 0.3);
  background: rgba(244, 67, 54, 0.1);
  color: #f44336;
  font-weight: 900;
  font-size: 16px;
  cursor: pointer;
  transition: all 0.3s ease;
  width: 44px;
  height: 44px;
  display: none; /* Hidden by default */
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.reset-btn:hover {
  background: rgba(244, 67, 54, 0.2);
  border-color: rgba(244, 67, 54, 0.5);
  transform: rotate(180deg) scale(1.1);
}

.reset-btn:disabled {
  opacity: 0.3;
  cursor: not-allowed;
  transform: none;
}

.end-half-btn:hover {
  background: linear-gradient(135deg, rgba(255, 152, 0, 0.3), rgba(255, 193, 7, 0.2));
  border-color: rgba(255, 152, 0, 0.6);
  transform: translateY(-2px);
  box-shadow: 0 4px 16px rgba(255, 152, 0, 0.3);
}

.end-half-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

.end-half-btn.completed {
  background: linear-gradient(135deg, rgba(76, 175, 80, 0.3), rgba(56, 142, 60, 0.2));
  border-color: rgba(76, 175, 80, 0.6);
  color: #4caf50;
}

.end-time-display {
  font-weight: 900;
  font-size: clamp(16px, 4vw, 18px);
  color: rgba(255, 255, 255, 0.8);
  background: rgba(0, 0, 0, 0.3);
  padding: 6px 12px;
  border-radius: 8px;
  border: 1px solid rgba(255, 255, 255, 0.2);
  min-width: 60px;
  text-align: center;
}

.end-time-display.set {
  color: #4caf50;
  background: rgba(76, 175, 80, 0.1);
  border-color: rgba(76, 175, 80, 0.3);
}

/* Auto-play controls */
.auto-controls {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  flex-wrap: wrap;
  gap: 12px;
}

.play-controls {
  display: flex;
  gap: 8px;
  align-items: center;
}

.play-btn, .live-btn {
  padding: 10px 16px;
  border-radius: 12px;
  border: 1px solid rgba(255, 255, 255, 0.2);
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: clamp(12px, 3.5vw, 14px);
}

.play-btn {
  background: rgba(76, 175, 80, 0.2);
  border-color: rgba(76, 175, 80, 0.4);
  color: #4caf50;
}

.play-btn:hover {
  background: rgba(76, 175, 80, 0.3);
  border-color: rgba(76, 175, 80, 0.6);
}

.play-btn.playing {
  background: rgba(255, 152, 0, 0.2);
  border-color: rgba(255, 152, 0, 0.4);
  color: #ff9800;
}

.live-btn {
  background: rgba(244, 67, 54, 0.2);
  border-color: rgba(244, 67, 54, 0.4);
  color: #f44336;
}

.live-btn:hover {
  background: rgba(244, 67, 54, 0.3);
  border-color: rgba(244, 67, 54, 0.6);
}

.auto-status {
  font-size: clamp(12px, 3vw, 14px);
  color: rgba(255, 255, 255, 0.7);
  font-weight: 600;
}

/* Export button styles */
.export-btn {
  padding: 8px 16px;
  border-radius: 8px;
  border: 1px solid rgba(255, 152, 0, 0.4);
  background: rgba(255, 152, 0, 0.2);
  color: #ff9800;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.3s ease;
  font-size: 12px;
}

.export-btn:hover {
  background: rgba(255, 152, 0, 0.3);
  border-color: rgba(255, 152, 0, 0.6);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3);
}

/* Tuner header */
.tuner-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.tuner-header h3 {
  margin: 0;
  font-size: clamp(18px, 4.5vw, 24px);
  font-weight: 900;
  color: var(--fg);
}

.bookmark-add-btn {
  font-size: clamp(12px, 3.5vw, 14px);
  padding: 8px 12px;
  background: linear-gradient(135deg, #ff9800, #ffc107);
  border-color: #ff9800;
  color: #fff;
}

.bookmark-add-btn:hover {
  background: linear-gradient(135deg, #ffc107, #ff9800);
  box-shadow: 0 4px 16px rgba(255, 152, 0, 0.4);
}

/* Bookmark controls */
.bookmark-controls {
  margin-top: 12px;
  text-align: center;
}

.bookmark-list-btn {
  font-size: clamp(12px, 3.5vw, 14px);
  padding: 10px 16px;
  background: rgba(33, 150, 243, 0.2);
  border-color: rgba(33, 150, 243, 0.4);
  color: #fff;
  width: 100%;
}

.bookmark-list-btn:hover {
  background: rgba(33, 150, 243, 0.3);
  border-color: rgba(33, 150, 243, 0.6);
}

/* Updated Tuner - Two-level timeline */
.tuner-wrap {
  position: relative;
  height: 240px; /* Increased height for two timelines */
  border-radius: 20px;
  overflow: hidden;
  background: linear-gradient(180deg, rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.2));
  border: 2px solid rgba(255, 255, 255, 0.2);
  margin-top: 8px;
  touch-action: none;
}

/* Timeline containers */
.timeline-container {
  position: absolute;
  left: 0;
  right: 0;
  height: 90px;
}

.timeline-first-half {
  top: 20px;
}

.timeline-second-half {
  top: 130px;
}

.timeline-label {
  position: absolute;
  left: 10px;
  top: -15px;
  font-size: 12px;
  font-weight: 900;
  padding: 4px 8px;
  border-radius: 8px;
  z-index: 20;
}

.timeline-label.first-half {
  background: linear-gradient(135deg, rgba(76, 175, 80, 0.8), rgba(56, 142, 60, 0.8));
  color: white;
}

.timeline-label.second-half {
  background: linear-gradient(135deg, rgba(139, 195, 74, 0.8), rgba(104, 159, 56, 0.8));
  color: white;
}

/* Scale adjustments for dual timeline */
.scale {
  position: absolute;
  inset: 0;
  will-change: transform;
  cursor: grab;
  transition: transform 0.1s ease-out;
}

.scale.dragging {
  cursor: grabbing;
  transition: none;
}

.baseline {
  position: absolute;
  left: 0;
  width: calc(150 * 60 * 3px);
  top: 50%;
  height: 2px;
  background: var(--line);
  opacity: 0.3;
}

.ticks {
  position: absolute;
  left: 0;
  top: 0;
  height: 100%;
}

.tick {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  height: 60px;
  width: 2px;
  background: var(--tick);
  transition: all 0.3s ease;
}

.tick.major {
  height: 80px;
  background: rgba(255, 255, 255, 0.8);
}

.tick .label {
  position: absolute;
  top: -20px;
  left: 8px;
  font-size: 12px;
  color: var(--fg);
  font-weight: 900;
  text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.8);
}

.tick .label.gr {
  color: var(--half1);
}

.tick .label.pu {
  color: var(--half2);
}

.tick .label.et1 {
  color: var(--et1);
}

.tick .label.et2 {
  color: var(--et2);
}

.tick .label.bd {
  color: var(--bound);
}

/* Dual needle system */
.needle-container {
  position: absolute;
  left: 50%;
  top: 0;
  bottom: 0;
  width: 0;
  pointer-events: none;
  z-index: 15;
}

.needle {
  position: absolute;
  left: -2px;
  width: 4px;
  background: linear-gradient(180deg, #fff, #ffeb3b);
  border-radius: 2px;
  transition: all 0.3s ease;
}

.needle.first-half {
  top: 35px;
  height: 60px;
}

.needle.second-half {
  top: 145px;
  height: 60px;
}

.needle.active {
  background: linear-gradient(180deg, #ffeb3b, #ff9800);
  box-shadow: 0 0 20px rgba(255, 235, 59, 0.8);
}

.needle.inactive {
  opacity: 0.3;
}

@keyframes needleGlow {
  0%, 100% { box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.5), 0 0 20px rgba(255, 235, 59, 0.8); }
  50% { box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.5), 0 0 30px rgba(255, 235, 59, 1); }
}

.needle-ball {
  position: absolute;
  left: -8px;
  top: -8px;
  font-size: 16px;
  animation: ballSpin 4s linear infinite;
}

@keyframes ballSpin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

/* Bookmarks on dual timeline */
.bookmarks {
  position: absolute;
  left: 0;
  top: 0;
  height: 100%;
  pointer-events: none;
}

.bookmark-marker {
  position: absolute;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  border-radius: 50%;
  background: rgba(0, 0, 0, 0.8);
  border: 2px solid #fff;
  cursor: pointer;
  pointer-events: auto;
  z-index: 10;
  animation: bookmarkPulse 2s ease-in-out infinite;
  transition: all 0.3s ease;
}

.bookmark-marker:hover {
  transform: scale(1.2);
  box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
}

@keyframes bookmarkPulse {
  0%, 100% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.4); }
  50% { box-shadow: 0 0 0 8px rgba(255, 255, 255, 0); }
}

.bookmark-marker.yellow { 
  background: #ffeb3b; 
  color: #000; 
  border-color: #fbc02d; 
  border-radius: 4px;
}
.bookmark-marker.red { 
  background: #f44336; 
  color: #fff; 
  border-color: #c62828; 
  border-radius: 4px;
}
.bookmark-marker.penalty { background: #4caf50; color: #fff; border-color: #2e7d32; }
.bookmark-marker.goal { background: #2196f3; color: #fff; border-color: #1565c0; }
.bookmark-marker.substitution { background: #9c27b0; color: #fff; border-color: #6a1b9a; }
.bookmark-marker.important { background: #ff9800; color: #fff; border-color: #e65100; }
.bookmark-marker.custom { background: #9c27b0; color: #fff; border-color: #6a1b9a; }

/* Bookmark form */
.bookmark-form {
  margin-top: 16px;
}

.event-types {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: 8px;
  margin-top: 8px;
}

.event-type {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 10px 12px;
  border: 2px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.3s ease;
  background: rgba(0, 0, 0, 0.2);
}

.event-type:hover {
  border-color: rgba(255, 255, 255, 0.4);
  background: rgba(255, 255, 255, 0.1);
}

.event-type input[type="radio"] {
  display: none;
}

.event-type input[type="radio"]:checked + .event-icon {
  transform: scale(1.2);
}

.event-type input[type="radio"]:checked ~ span {
  color: #fff;
  font-weight: 700;
}

.event-type:has(input[type="radio"]:checked) {
  border-color: #4caf50;
  background: rgba(76, 175, 80, 0.2);
}

.event-icon {
  font-size: 18px;
  transition: transform 0.3s ease;
}

.event-type span:last-child {
  font-size: clamp(11px, 3vw, 13px);
  font-weight: 600;
}

#bookmarkNote {
  width: 100%;
  padding: 12px;
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 8px;
  background: rgba(0, 0, 0, 0.3);
  color: #fff;
  font-size: 14px;
}

#bookmarkNote:focus {
  outline: none;
  border-color: #4caf50;
  box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
}

#bookmarkNote::placeholder {
  color: rgba(255, 255, 255, 0.5);
}

#bookmarkDropdown {
  width: 100%;
  padding: 12px;
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 8px;
  background: rgba(0, 0, 0, 0.3);
  color: #fff;
  font-size: 14px;
  cursor: pointer;
}

#bookmarkDropdown:focus {
  outline: none;
  border-color: #4caf50;
  box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.2);
}

#bookmarkDropdown option {
  background: rgba(0, 0, 0, 0.9);
  color: #fff;
  padding: 8px;
}

/* Bookmark list */
.bookmark-list {
  max-height: 70vh;
  overflow-y: auto;
  margin-top: 12px;
}

.bookmark-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 12px;
  margin-bottom: 8px;
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 12px;
  background: rgba(0, 0, 0, 0.2);
  transition: all 0.3s ease;
}

.bookmark-item:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(255, 255, 255, 0.3);
}

.bookmark-info {
  display: flex;
  align-items: center;
  gap: 12px;
  flex: 1;
}

.bookmark-info .event-icon {
  font-size: 20px;
}

.bookmark-details {
  flex: 1;
}

.bookmark-time {
  font-weight: 900;
  font-size: 16px;
  color: #4caf50;
}

.bookmark-note {
  font-size: 12px;
  color: rgba(255, 255, 255, 0.7);
  margin-top: 2px;
}

.bookmark-actions {
  display: flex;
  gap: 8px;
}

.bookmark-goto, .bookmark-delete {
  padding: 6px 10px;
  font-size: 12px;
  border-radius: 6px;
}

.bookmark-goto {
  background: rgba(76, 175, 80, 0.2);
  border-color: rgba(76, 175, 80, 0.4);
  color: #4caf50;
}

.bookmark-goto:hover {
  background: rgba(76, 175, 80, 0.3);
}

.bookmark-delete {
  background: rgba(244, 67, 54, 0.2);
  border-color: rgba(244, 67, 54, 0.4);
  color: #f44336;
}

.bookmark-delete:hover {
  background: rgba(244, 67, 54, 0.3);
}

.clear-all-btn {
  font-size: clamp(11px, 3vw, 12px);
  padding: 8px 12px;
  background: rgba(244, 67, 54, 0.2);
  border-color: rgba(244, 67, 54, 0.4);
  color: #f44336;
}

.clear-all-btn:hover {
  background: rgba(244, 67, 54, 0.3);
  border-color: rgba(244, 67, 54, 0.6);
}

.bookmark-empty {
  text-align: center;
  padding: 40px 20px;
  color: rgba(255, 255, 255, 0.5);
  font-size: 14px;
}

.label {
  display: flex;
  align-items: center;
  gap: 12px;
  font-weight: 900;
  letter-spacing: 0.3px;
  font-size: clamp(16px, 4vw, 20px);
  flex-wrap: wrap;
}

.dot {
  width: 16px;
  height: 16px;
  border-radius: 50%;
  box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.3) inset, 0 0 16px currentColor;
  animation: dotPulse 2s ease-in-out infinite;
}

@keyframes dotPulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.3) inset, 0 0 20px currentColor; }
}

.dot.g {
  color: var(--half1);
  background: var(--half1);
}

.dot.p {
  color: var(--half2);
  background: var(--half2);
}

/* Buttons and inputs */
select, button {
  border: 1px solid rgba(255, 255, 255, 0.2);
  background: rgba(0, 0, 0, 0.3);
  color: var(--fg);
  border-radius: 12px;
  padding: 12px 16px;
  font-weight: 700;
  cursor: pointer;
  font-size: clamp(14px, 4vw, 18px);
  transition: all 0.3s ease;
  backdrop-filter: blur(5px);
}

select {
  min-width: 80px;
}

button:hover, select:hover {
  background: rgba(255, 255, 255, 0.1);
  border-color: rgba(255, 255, 255, 0.4);
  transform: translateY(-1px);
}

/* Button animations */
.btn-animate {
  position: relative;
  overflow: hidden;
}

.btn-animate::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  background: rgba(255, 255, 255, 0.2);
  border-radius: 50%;
  transform: translate(-50%, -50%);
  transition: width 0.6s ease, height 0.6s ease;
}

.btn-animate:active::before {
  width: 300px;
  height: 300px;
}

.btn-animate:active {
  transform: scale(0.95);
}

.btn-main {
  background: linear-gradient(135deg, var(--half1), var(--half2));
  border-color: var(--half1);
  font-weight: 900;
}

.btn-main:hover {
  background: linear-gradient(135deg, var(--half2), var(--half1));
  box-shadow: 0 4px 20px rgba(76, 175, 80, 0.4);
}

/* Readout bar */
.readout-bar {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 14px;
  margin-top: 16px;
}

.bar-pill {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 14px;
  padding: 16px 18px;
  border-radius: 18px;
  border: 1px solid rgba(255, 255, 255, 0.2);
  background: rgba(0, 0, 0, 0.3);
  backdrop-filter: blur(8px);
  transition: all 0.3s ease;
}

.bar-pill:hover {
  background: rgba(0, 0, 0, 0.4);
  border-color: rgba(255, 255, 255, 0.3);
  transform: translateY(-2px);
}

.bar-label {
  font-weight: 800;
  letter-spacing: 0.4px;
  color: rgba(255, 255, 255, 0.8);
  font-size: clamp(12px, 3.5vw, 14px);
}

.bar-hint {
  font-size: clamp(10px, 2.5vw, 11px);
  color: rgba(255, 255, 255, 0.5);
  margin-top: 2px;
}

.bar-value {
  font-variant-numeric: tabular-nums;
  font-weight: 900;
  letter-spacing: 0.8px;
  font-size: clamp(24px, 8vw, 42px);
  text-shadow: 0 2px 12px rgba(0, 0, 0, 0.8);
}

.bar-real {
  border-color: rgba(255, 255, 255, 0.2);
}

.bar-real .bar-value {
  color: #ffffff;
}

.bar-field {
  cursor: pointer;
}

.bar-field.h1 {
  background: linear-gradient(135deg, rgba(76, 175, 80, 0.2), rgba(56, 142, 60, 0.2));
  border-color: rgba(76, 175, 80, 0.4);
}

.bar-field.h1 .bar-value {
  color: var(--half1);
}

.bar-field.h2 {
  background: linear-gradient(135deg, rgba(139, 195, 74, 0.2), rgba(104, 159, 56, 0.2));
  border-color: rgba(139, 195, 74, 0.4);
}

.bar-field.h2 .bar-value {
  color: var(--half2);
}

.bar-field.et1 {
  background: linear-gradient(135deg, rgba(255, 152, 0, 0.2), rgba(255, 193, 7, 0.2));
  border-color: rgba(255, 152, 0, 0.4);
}

.bar-field.et1 .bar-value {
  color: var(--et1);
}

.bar-field.et2 {
  background: linear-gradient(135deg, rgba(244, 67, 54, 0.2), rgba(211, 47, 47, 0.2));
  border-color: rgba(244, 67, 54, 0.4);
}

.bar-field.et2 .bar-value {
  color: var(--et2);
}

/* Bottom sheet */
.sheet-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.6);
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
  backdrop-filter: blur(4px);
}

.sheet {
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;
  transform: translateY(100%);
  transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  z-index: 30;
}

.sheet .panel {
  margin: 0 12px 12px;
  background: rgba(46, 125, 50, 0.95);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: 20px;
  padding: 20px;
  box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(15px);
}

.sheet .row {
  justify-content: space-between;
}

.sheet.open {
  transform: translateY(0);
}

.sheet-backdrop.open {
  opacity: 1;
  pointer-events: auto;
}

.chips button {
  padding: 10px 16px;
  border-radius: 20px;
  border: 1px solid rgba(255, 255, 255, 0.3);
  background: rgba(0, 0, 0, 0.3);
  font-size: 14px;
}

.chips button:hover {
  background: rgba(255, 255, 255, 0.2);
  transform: scale(1.05);
}

/* Responsive adjustments */
@media (max-width: 640px) {
  .auto-controls {
    flex-direction: column;
    gap: 8px;
  }
  
  .play-controls {
    justify-content: center;
    width: 100%;
    flex-wrap: wrap;
  }
  
  .play-controls button {
    flex: 1 1 auto;
    min-width: 100px;
    max-width: 140px;
  }
  
  .export-btn {
    font-size: 11px;
    padding: 6px 12px;
  }
  
  .team-inputs {
    flex-direction: column;
    gap: 15px;
  }
  
  .vs-divider {
    width: 50px;
    height: 50px;
    font-size: 16px;
  }
  
  .team-input-group {
    min-width: 100%;
  }
  
  .group {
    flex: 1 1 100%;
  }
  
  .tuner-wrap {
    height: 280px;
  }
  
  .readout-bar {
    grid-template-columns: 1fr;
  }
  
  .half-end-controls {
    flex-direction: column;
    gap: 15px;
  }
  
  .control-group {
    min-width: 100%;
  }
  
  .control-buttons {
    max-width: 280px;
  }
  
  .end-half-btn {
    font-size: 14px;
    padding: 10px 16px;
  }
  
  h1 {
    font-size: clamp(20px, 6vw, 28px);
  }
}

@media (max-width: 480px) {
  .play-controls {
    flex-direction: column;
    width: 100%;
  }
  
  .play-controls button {
    width: 100%;
    max-width: none;
    margin-bottom: 4px;
  }
}

/* Loading animation */
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes fadeInOut {
  0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
  20%, 80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
  100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
}

.card {
  animation: fadeInUp 0.6s ease-out;
}

.card:nth-child(2) {
  animation-delay: 0.1s;
}

.card:nth-child(3) {
  animation-delay: 0.2s;
}
</style>

</head>
<body>
  <div class="field-background"></div>
  
  <h1>⚽ Football Time Tuner</h1>

  <!-- ชื่อทีม -->
  <div class="card card-teams">
    <div class="team-inputs">
      <div class="team-input-group">
        <label for="teamA">🏠 ทีมเจ้าบ้าน:</label>
        <input type="text" id="teamA" placeholder="ชื่อทีม A" maxlength="30">
      </div>
      <div class="vs-divider">
        <span>VS</span>
      </div>
      <div class="team-input-group">
        <label for="teamB">🚌 ทีมเยือน:</label>
        <input type="text" id="teamB" placeholder="ชื่อทีม B" maxlength="30">
      </div>
    </div>
  </div>

  <!-- เริ่มครึ่งแรก / ครึ่งหลัง -->
  <div class="card card-halftime">
    <div class="row">
      <div class="group g1">
        <div class="label"><span class="dot g"></span>เริ่มครึ่งแรก</div>
        <div class="row" style="gap:8px">
          <select id="t1h"></select><select id="t1m"></select>
          <button id="t1now" class="btn-animate">ตอนนี้</button>
        </div>
      </div>
      <div class="group g2">
        <div class="label"><span class="dot p"></span>เริ่มครึ่งหลัง</div>
        <div class="row" style="gap:8px">
          <select id="t2h"></select><select id="t2m"></select>
          <button id="t2now" class="btn-animate">ตอนนี้</button>
        </div>
      </div>
    </div>
    
    <!-- Half End Controls -->
    <div class="half-end-controls">
      <div class="control-group">
        <div class="control-buttons">
          <button id="endFirstHalf" class="btn-animate end-half-btn">⏹️ จบครึ่งแรก</button>
          <button id="resetFirstHalf" class="btn-animate reset-btn" title="รีเซ็ตเวลาจบครึ่งแรก">🔄</button>
        </div>
        <span id="firstHalfEndTime" class="end-time-display">--:--</span>
      </div>
      <div class="control-group">
        <div class="control-buttons">
          <button id="endSecondHalf" class="btn-animate end-half-btn">🏁 จบเกม</button>
          <button id="resetSecondHalf" class="btn-animate reset-btn" title="รีเซ็ตเวลาจบเกม">🔄</button>
        </div>
        <span id="secondHalfEndTime" class="end-time-display">--:--</span>
      </div>
    </div>
  </div>

  <!-- Tuner -->
  <div class="card card-tuner">
    <!-- Auto-play controls -->
    <div class="auto-controls">
      <div class="play-controls">
        <button id="playBtn" class="play-btn btn-animate">▶️ Play</button>
        <button id="liveBtn" class="live-btn btn-animate">🔴 LIVE</button>
        <button id="exportBtn" class="export-btn btn-animate">📄 Export PDF</button>
      </div>
      <div class="auto-status" id="autoStatus">Paused</div>
    </div>
    
    <div class="tuner-header">
      <h3>⚽ หน้าปัดเวลาสนาม</h3>
      <button id="addBookmarkBtn" class="btn-animate bookmark-add-btn" title="เพิ่มเหตุการณ์">
        📌 เพิ่มเหตุการณ์
      </button>
    </div>
    
    <div class="tuner-wrap" id="wrap" aria-label="time tuner">
      <!-- Timeline labels -->
      <div class="timeline-label first-half">ครึ่งแรก</div>
      <div class="timeline-label second-half">ครึ่งหลัง</div>
      
      <!-- Timeline containers -->
      <div class="timeline-container timeline-first-half">
        <div class="scale" id="scaleFirstHalf">
          <div class="baseline"></div>
          <div class="ticks" id="ticksFirstHalf"></div>
          <div class="bookmarks" id="bookmarksFirstHalf"></div>
        </div>
      </div>
      
      <div class="timeline-container timeline-second-half">
        <div class="scale" id="scaleSecondHalf">
          <div class="baseline"></div>
          <div class="ticks" id="ticksSecondHalf"></div>
          <div class="bookmarks" id="bookmarksSecondHalf"></div>
        </div>
      </div>
      
      <!-- Dual needles -->
      <div class="needle-container">
        <div class="needle first-half" id="needleFirstHalf">
          <div class="needle-ball">⚽</div>
        </div>
        <div class="needle second-half" id="needleSecondHalf">
          <div class="needle-ball">⚽</div>
        </div>
      </div>
    </div>

    <!-- Readout below dial -->
    <div class="readout-bar">
      <div class="bar-pill bar-real">
        <div class="bar-label">🕘 เวลาจริง</div>
        <div class="bar-value mono" id="barReal">--:--</div>
      </div>
      <!-- แตะเพื่อเปิดเลือกเวลา (seek) -->
      <div class="bar-pill bar-field h1 btn-animate" id="barFieldPill" role="button" aria-haspopup="dialog" aria-controls="seekSheet">
        <div>
          <div class="bar-label">⚽ เวลาสนาม</div>
          <div class="bar-hint">คลิกเพื่อเปลี่ยนเวลา</div>
        </div>
        <div class="bar-value mono" id="barField">00:00</div>
      </div>
    </div>
    
    <!-- Bookmark controls -->
    <div class="bookmark-controls">
      <button id="viewBookmarksBtn" class="btn-animate bookmark-list-btn">
        📋 ดูเหตุการณ์ทั้งหมด (<span id="bookmarkCount">0</span>)
      </button>
    </div>
  </div>

  <!-- Bottom sheet: Seek picker -->
  <div class="sheet-backdrop" id="sheetBackdrop"></div>
  <div class="sheet" id="seekSheet" aria-modal="true">
    <div class="panel">
      <div class="row">
        <div class="label" style="gap:10px">🎯 ไปที่เวลา:</div>
        <div class="row" style="gap:8px">
          <select id="sheetMin" aria-label="นาที"></select> :
          <select id="sheetSec" aria-label="วินาที"></select>
        </div>
      </div>
      <div class="row" style="margin-top:10px;gap:8px">
        <div class="chips" style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="quick0" class="btn-animate">00:00</button>
          <button id="quick45" class="btn-animate">45:00</button>
          <button id="quick45plus5" class="btn-animate">45+5:00</button>
          <button id="quick90" class="btn-animate">90:00</button>
          <button id="quick90plus5" class="btn-animate">90+5:00</button>
          <button id="quick90plus10" class="btn-animate">90+10:00</button>
        </div>
        <div style="margin-left:auto;display:flex;gap:8px">
          <button id="sheetCancel" class="btn-animate">ยกเลิก</button>
          <button class="btn-main btn-animate" id="sheetGo">⚽ ไป</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom sheet: Bookmark Manager -->
  <div class="sheet-backdrop" id="bookmarkBackdrop"></div>
  <div class="sheet" id="bookmarkSheet" aria-modal="true">
    <div class="panel">
      <div class="row">
        <div class="label">📌 เพิ่มเหตุการณ์ที่เวลา: <span id="bookmarkTime">00:00</span></div>
      </div>
      
      <div class="bookmark-form">
        <div class="row" style="margin-top:12px">
          <div class="label">ประเภทเหตุการณ์:</div>
        </div>
        <div class="event-types">
          <label class="event-type">
            <input type="radio" name="eventType" value="yellow" checked>
            <span class="event-icon">🟨</span>
            <span>ใบเหลือง</span>
          </label>
          <label class="event-type">
            <input type="radio" name="eventType" value="red">
            <span class="event-icon">🟥</span>
            <span>ใบแดง</span>
          </label>
          <label class="event-type">
            <input type="radio" name="eventType" value="penalty">
            <span class="event-icon">🔴</span>
            <span>จุดโทษ</span>
          </label>
          <label class="event-type">
            <input type="radio" name="eventType" value="goal">
            <span class="event-icon">⚽</span>
            <span>ประตู</span>
          </label>
          <label class="event-type">
            <input type="radio" name="eventType" value="substitution">
            <span class="event-icon">🔄</span>
            <span>เปลี่ยนตัว</span>
          </label>
          <label class="event-type">
            <input type="radio" name="eventType" value="important">
            <span class="event-icon">⭐</span>
            <span>เหตุการณ์สำคัญ</span>
          </label>
          <label class="event-type">
            <input type="radio" name="eventType" value="custom">
            <span class="event-icon">📝</span>
            <span>กำหนดเอง</span>
          </label>
        </div>
        
        <div class="row" style="margin-top:12px">
          <select id="bookmarkDropdown" style="display: none; width: 100%; margin-bottom: 8px; font-size: 14px;">
            <option value="">เลือก</option>
          </select>
          <input type="text" id="bookmarkNote" placeholder="หมายเหตุ (ไม่บังคับ)" maxlength="50">
        </div>
        
        <div class="row" style="margin-top:12px; gap:8px">
          <button id="bookmarkCancel" class="btn-animate">ยกเลิก</button>
          <button id="bookmarkSave" class="btn-main btn-animate">💾 บันทึก</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bookmark List Sheet -->
  <div class="sheet-backdrop" id="bookmarkListBackdrop"></div>
  <div class="sheet" id="bookmarkListSheet" aria-modal="true">
    <div class="panel">
      <div class="row">
        <div class="label">📋 รายการเหตุการณ์</div>
        <div style="display: flex; gap: 8px;">
          <button id="clearAllBookmarks" class="btn-animate clear-all-btn">🗑️ ลบทั้งหมด</button>
          <button id="bookmarkListClose" class="btn-animate">ปิด</button>
        </div>
      </div>
      <div class="bookmark-list" id="bookmarkList">
        <!-- จะถูกเติมด้วย JavaScript -->
      </div>
    </div>
  </div>

<script>
/* === Football Time Tuner JavaScript with Dual Timeline === */

// Configuration constants
const tz = 'Asia/Bangkok';
const MAX_SEC = 150 * 60; // 150 minutes (enough for very long extra time)
const BASE_PX_PER_SEC = 3; // Base pixels per second

// Zoom system
let currentZoomLevel = 1; // 1x zoom by default
const ZOOM_LEVELS = [0.25, 0.5, 1, 2, 4, 8]; // Available zoom levels
let PX_PER_SEC = BASE_PX_PER_SEC; // Current pixels per second (changes with zoom)

// PDF Export libraries - loaded dynamically
let html2canvas = null;
let jsPDF = null;

// Utility functions
const pad2 = n => String(n).padStart(2, '0');
const fmtMMSS = s => `${pad2(Math.floor(s / 60))}:${pad2(Math.floor(s % 60))}`;
const fmtClockHM = d => d.toLocaleTimeString('th-TH', {
  hour: '2-digit',
  minute: '2-digit',
  hour12: false,
  timeZone: tz
});
const $ = q => document.querySelector(q);

// Local storage keys for persistence
const LS_KEYS = {
  t1h: 'ftt_t1h',
  t1m: 'ftt_t1m',
  t2h: 'ftt_t2h',
  t2m: 'ftt_t2m',
  seekPos: 'ftt_seek_position',
  teamA: 'ftt_team_a',
  teamB: 'ftt_team_b',
  firstHalfEnd: 'ftt_first_half_end',
  secondHalfEnd: 'ftt_second_half_end'
};

// DOM Elements
const elements = {
  // Team inputs
  teamA: $('#teamA'),
  teamB: $('#teamB'),
  
  // Time inputs
  t1h: $('#t1h'),
  t1m: $('#t1m'),
  t2h: $('#t2h'),
  t2m: $('#t2m'),
  
  // Buttons
  t1now: $('#t1now'),
  t2now: $('#t2now'),
  
  // Half end controls
  endFirstHalf: $('#endFirstHalf'),
  endSecondHalf: $('#endSecondHalf'),
  resetFirstHalf: $('#resetFirstHalf'),
  resetSecondHalf: $('#resetSecondHalf'),
  firstHalfEndTime: $('#firstHalfEndTime'),
  secondHalfEndTime: $('#secondHalfEndTime'),
  
  // Auto-play controls
  playBtn: $('#playBtn'),
  liveBtn: $('#liveBtn'),
  autoStatus: $('#autoStatus'),
  
  // Tuner components
  wrap: $('#wrap'),
  scaleFirstHalf: $('#scaleFirstHalf'),
  scaleSecondHalf: $('#scaleSecondHalf'),
  ticksFirstHalf: $('#ticksFirstHalf'),
  ticksSecondHalf: $('#ticksSecondHalf'),
  bookmarksFirstHalf: $('#bookmarksFirstHalf'),
  bookmarksSecondHalf: $('#bookmarksSecondHalf'),
  needleFirstHalf: $('#needleFirstHalf'),
  needleSecondHalf: $('#needleSecondHalf'),
  
  // Display bars
  barReal: $('#barReal'),
  barField: $('#barField'),
  barFieldPill: $('#barFieldPill'),
  
  // Bottom sheet
  sheet: $('#seekSheet'),
  backdrop: $('#sheetBackdrop'),
  sheetMin: $('#sheetMin'),
  sheetSec: $('#sheetSec'),
  sheetGo: $('#sheetGo'),
  sheetCancel: $('#sheetCancel'),
  
  // Quick buttons
  quick0: $('#quick0'),
  quick45: $('#quick45'),
  quick90: $('#quick90'),
  
  // Bookmark elements
  addBookmarkBtn: $('#addBookmarkBtn'),
  viewBookmarksBtn: $('#viewBookmarksBtn'),
  bookmarkCount: $('#bookmarkCount'),
  
  // Bookmark sheet
  bookmarkSheet: $('#bookmarkSheet'),
  bookmarkBackdrop: $('#bookmarkBackdrop'),
  bookmarkTime: $('#bookmarkTime'),
  bookmarkNote: $('#bookmarkNote'),
  bookmarkDropdown: $('#bookmarkDropdown'),
  bookmarkSave: $('#bookmarkSave'),
  bookmarkCancel: $('#bookmarkCancel'),
  
  // Bookmark list sheet
  bookmarkListSheet: $('#bookmarkListSheet'),
  bookmarkListBackdrop: $('#bookmarkListBackdrop'),
  bookmarkListClose: $('#bookmarkListClose'),
  bookmarkList: $('#bookmarkList'),
  clearAllBookmarks: $('#clearAllBookmarks'),
  
  // Export button
  exportBtn: $('#exportBtn')
};

// State variables
let start1Sec = null;
let start2Sec = null;
let firstHalfEndSec = null; // เวลาจบครึ่งแรก (field time)
let secondHalfEndSec = null; // เวลาจบครึ่งหลัง (field time)
let seekSecVal = 0; // Current seek position (0-9000 seconds)
let dragging = false;
let lastX = 0;

// Auto-play state variables
let isAutoPlaying = false;
let autoPlayInterval = null;
let playbackSpeed = 1; // Fixed at 1x speed
let autoPlayStartTime = null;
let autoPlayStartFieldTime = 0;

// Bookmarks system
let bookmarks = []; // Array of bookmark objects
const BOOKMARK_STORAGE_KEY = 'ftt_bookmarks';

// Event type configurations with team dropdown options
const EVENT_TYPES = {
  yellow: { 
    icon: '🟨', 
    name: 'ใบเหลือง', 
    class: 'yellow',
    teamOptions: ['Home', 'Away']
  },
  red: { 
    icon: '🟥', 
    name: 'ใบแดง', 
    class: 'red',
    teamOptions: ['Home', 'Away']
  },
  penalty: { icon: '🔴', name: 'จุดโทษ', class: 'penalty' },
  goal: { 
    icon: '⚽', 
    name: 'ประตู', 
    class: 'goal',
    scoreOptions: true
  },
  substitution: { 
    icon: '🔄', 
    name: 'เปลี่ยนตัว', 
    class: 'substitution',
    teamOptions: ['Home', 'Away']
  },
  important: { 
    icon: '⭐', 
    name: 'เหตุการณ์สำคัญ', 
    class: 'important',
    importantOptions: true
  },
  custom: { icon: '📝', name: 'กำหนดเอง', class: 'custom' }
};

/* === PDF Export Functions === */

// Load external libraries for PDF export
async function loadPDFLibraries() {
  if (html2canvas && jsPDF) return true;
  
  try {
    const loadingEl = createLoadingIndicator('กำลังเตรียมการ export...');
    
    if (!html2canvas) {
      await loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js');
      html2canvas = window.html2canvas;
    }
    
    if (!jsPDF) {
      await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
      jsPDF = window.jspdf.jsPDF;
    }
    
    removeLoadingIndicator(loadingEl);
    return true;
  } catch (error) {
    console.error('Failed to load PDF libraries:', error);
    alert('ไม่สามารถโหลด libraries สำหรับสร้าง PDF ได้');
    return false;
  }
}

function loadScript(src) {
  return new Promise((resolve, reject) => {
    const script = document.createElement('script');
    script.src = src;
    script.onload = resolve;
    script.onerror = reject;
    document.head.appendChild(script);
  });
}

function createLoadingIndicator(text) {
  const loading = document.createElement('div');
  loading.style.cssText = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.9);
    color: white;
    padding: 20px 30px;
    border-radius: 12px;
    font-weight: bold;
    z-index: 10000;
    display: flex;
    align-items: center;
    gap: 12px;
  `;
  loading.innerHTML = `
    <div style="width: 20px; height: 20px; border: 2px solid #fff; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
    ${text}
  `;
  
  if (!document.getElementById('spin-style')) {
    const style = document.createElement('style');
    style.id = 'spin-style';
    style.textContent = '@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }';
    document.head.appendChild(style);
  }
  
  document.body.appendChild(loading);
  return loading;
}

function removeLoadingIndicator(loadingEl) {
  if (loadingEl && loadingEl.parentNode) {
    loadingEl.parentNode.removeChild(loadingEl);
  }
}

function getMatchTitle() {
  let teamA = '';
  let teamB = '';
  
  try {
    const savedTeamA = localStorage.getItem(LS_KEYS.teamA);
    const savedTeamB = localStorage.getItem(LS_KEYS.teamB);
    
    if (savedTeamA) teamA = savedTeamA.trim();
    if (savedTeamB) teamB = savedTeamB.trim();
  } catch (e) {
    console.warn('Error reading from localStorage:', e);
  }
  
  if (!teamA) {
    const teamAElement = document.querySelector('#teamA');
    if (teamAElement && teamAElement.value) {
      teamA = teamAElement.value.trim();
    }
  }
  
  if (!teamB) {
    const teamBElement = document.querySelector('#teamB');
    if (teamBElement && teamBElement.value) {
      teamB = teamBElement.value.trim();
    }
  }
  
  if (!teamA) teamA = 'ทีม A';
  if (!teamB) teamB = 'ทีม B';
  
  return `${teamA} VS ${teamB}`;
}

function generateMatchStats() {
  const now = new Date();
  const matchDate = now.toLocaleDateString('th-TH', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
    timeZone: tz
  });
  
  const statsByType = {};
  Object.keys(EVENT_TYPES).forEach(key => {
    statsByType[key] = bookmarks.filter(b => b.type === key).length;
  });
  
  const firstHalfStart = secToHM(start1Sec);
  const secondHalfStart = secToHM(start2Sec);
  const matchTitle = getMatchTitle();
  
  return {
    matchTitle,
    matchDate,
    firstHalfStart,
    secondHalfStart,
    firstHalfEnd: firstHalfEndSec ? formatTimeForPDF(firstHalfEndSec) : 'ยังไม่กำหนด',
    secondHalfEnd: secondHalfEndSec ? formatTimeForPDF(secondHalfEndSec) : 'ยังไม่กำหนด',
    totalEvents: bookmarks.length,
    statsByType,
    currentPosition: formatTimeForPDF(seekSecVal),
    exportTime: now.toLocaleString('th-TH', { timeZone: tz })
  };
}

async function exportMatchToPDF() {
  let loadingEl = null;
  
  try {
    if (!start1Sec || !start2Sec) {
      alert('กรุณาตั้งเวลาเริ่มครึ่งแรกและครึ่งหลังก่อนส่งออก PDF');
      return;
    }

    // Ensure team names are saved
    const teamAEl = document.querySelector('#teamA');
    const teamBEl = document.querySelector('#teamB');
    if (teamAEl && teamAEl.value.trim()) {
      localStorage.setItem(LS_KEYS.teamA, teamAEl.value.trim());
    }
    if (teamBEl && teamBEl.value.trim()) {
      localStorage.setItem(LS_KEYS.teamB, teamBEl.value.trim());
    }

    const loaded = await loadPDFLibraries();
    if (!loaded) return;

    loadingEl = createLoadingIndicator('กำลังสร้าง PDF หลายหน้า...');

    const stats = generateMatchStats();
    await createPDFReport(stats, loadingEl);
    
  } catch (error) {
    console.error('Export failed:', error);
    
    if (loadingEl) {
      removeLoadingIndicator(loadingEl);
    }
    
    let errorMessage = 'เกิดข้อผิดพลาดในการส่งออก PDF';
    if (error.message) {
      errorMessage += ':\n' + error.message;
    }
    alert(errorMessage);
  }
}

async function createPDFReport(stats, loadingEl) {
  const pdf = new jsPDF('p', 'mm', 'a4');
  let currentPage = 1;
  
  updateLoadingMessage(loadingEl, 'กำลังสร้างหน้าที่ 1...');
  
  // Create summary page
  await addSummaryPageToPDF(pdf, stats);
  
  // Create events pages if there are bookmarks
  if (bookmarks.length > 0) {
    const eventsPerPage = 15;
    const totalPages = Math.ceil(bookmarks.length / eventsPerPage);
    
    for (let page = 0; page < totalPages; page++) {
      currentPage++;
      updateLoadingMessage(loadingEl, `กำลังสร้างหน้าที่ ${currentPage}...`);
      
      const startIndex = page * eventsPerPage;
      const endIndex = Math.min(startIndex + eventsPerPage, bookmarks.length);
      const pageBookmarks = bookmarks.slice(startIndex, endIndex);
      
      pdf.addPage();
      await addEventsPageToPDF(pdf, pageBookmarks, page + 1, totalPages, stats);
    }
  }
  
  updateLoadingMessage(loadingEl, 'กำลังบันทึกไฟล์...');
  
  const now = new Date();
  const dateStr = now.toLocaleDateString('th-TH').replace(/\//g, '-');
  const timeStr = now.toLocaleTimeString('th-TH', { hour12: false }).replace(/:/g, '-');
  const filename = `Football-Match-Report-${dateStr}-${timeStr}.pdf`;
  
  pdf.save(filename);
  
  removeLoadingIndicator(loadingEl);
  
  showSuccessMessage(`✅ ส่งออก PDF สำเร็จ! (${currentPage} หน้า)`);
}

async function addSummaryPageToPDF(pdf, stats) {
  const htmlContent = createSummaryHTML(stats);
  await addHTMLPageToPDF(pdf, htmlContent);
}

async function addEventsPageToPDF(pdf, pageBookmarks, pageNumber, totalPages, stats) {
  const htmlContent = createEventsHTML(pageBookmarks, pageNumber, totalPages, stats);
  await addHTMLPageToPDF(pdf, htmlContent);
}

async function addHTMLPageToPDF(pdf, htmlContent) {
  const container = document.createElement('div');
  container.style.cssText = `
    position: absolute;
    top: -10000px;
    left: -10000px;
    width: 210mm;
    height: 297mm;
    background: white;
    padding: 15mm;
    box-sizing: border-box;
    font-family: 'Sarabun', 'Noto Sans Thai', 'Kanit', sans-serif;
  `;
  
  container.innerHTML = htmlContent;
  
  // Add Google Fonts for Thai support
  const fontLink = document.createElement('link');
  fontLink.href = 'https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;700&family=Noto+Sans+Thai:wght@300;400;700&family=Kanit:wght@300;400;700&display=swap';
  fontLink.rel = 'stylesheet';
  document.head.appendChild(fontLink);
  
  document.body.appendChild(container);
  
  // Wait for fonts to load
  await new Promise(resolve => setTimeout(resolve, 1000));
  
  try {
    const canvas = await html2canvas(container, {
      width: 794,  // A4 width in pixels at 96 DPI
      height: 1123, // A4 height in pixels at 96 DPI
      scale: 2,
      useCORS: true,
      allowTaint: true,
      backgroundColor: '#ffffff',
      fontEmbedded: true
    });
    
    if (canvas) {
      const imgWidth = 210;
      const imgHeight = 297;
      
      pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, 0, imgWidth, imgHeight);
    }
  } finally {
    document.body.removeChild(container);
  }
}

function createSummaryHTML(stats) {
  const statsRows = Object.entries(stats.statsByType)
    .filter(([_, count]) => count > 0)
    .map(([type, count]) => {
      const eventType = EVENT_TYPES[type];
      if (!eventType) return '';
      return `
        <tr>
          <td style="padding: 8px; border: 1px solid #ddd; font-size: 14px;">
            ${eventType.icon} ${eventType.name}
          </td>
          <td style="padding: 8px; border: 1px solid #ddd; text-align: center; font-weight: bold; font-size: 14px;">
            ${count}
          </td>
        </tr>
      `;
    }).filter(row => row !== '').join('');

  return `
    <div style="
      font-family: 'Sarabun', 'Noto Sans Thai', 'Kanit', sans-serif;
      color: #333;
      line-height: 1.6;
      height: 267mm;
      overflow: hidden;
      padding: 10mm;
    ">
      <div style="text-align: center; border-bottom: 3px solid #4caf50; padding-bottom: 20px; margin-bottom: 30px;">
        <h1 style="color: #2e7d32; margin: 0; font-size: 32px; font-weight: bold;">
          ⚽ สรุปการแข่งขันฟุตบอล
        </h1>
        <h2 style="color: #4caf50; margin: 10px 0 0 0; font-size: 24px; font-weight: bold;">
          ${stats.matchTitle}
        </h2>
        <p style="margin: 10px 0 0 0; color: #666; font-size: 16px;">
          Thai League Report
        </p>
      </div>

      <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 25px;">
        <h2 style="color: #2e7d32; margin-top: 0; font-size: 20px;">📅 ข้อมูลการแข่งขัน</h2>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <div style="font-size: 14px; line-height: 1.8;">
            <strong>วันที่การแข่งขัน:</strong> ${stats.matchDate}<br>
            <strong>เริ่มครึ่งแรก:</strong> ${stats.firstHalfStart}<br>
            <strong>เริ่มครึ่งหลัง:</strong> ${stats.secondHalfStart}<br>
            <strong>จบครึ่งแรก:</strong> ${stats.firstHalfEnd}
          </div>
          <div style="font-size: 14px; line-height: 1.8;">
            <strong>จบเกม:</strong> ${stats.secondHalfEnd}<br>
            <strong>ตำแหน่งปัจจุบัน:</strong> ${stats.currentPosition}<br>
            <strong>เวลาที่สร้างรายงาน:</strong> ${stats.exportTime}
          </div>
        </div>
      </div>

      <div style="margin-bottom: 25px;">
        <h2 style="color: #2e7d32; font-size: 20px;">📊 สถิติสรุป</h2>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
          <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; text-align: center;">
            <div style="font-size: 36px; font-weight: bold; color: #2e7d32;">
              ${stats.totalEvents}
            </div>
            <div style="color: #666; font-size: 16px;">เหตุการณ์ทั้งหมด</div>
          </div>
          <div style="background: #fff3e0; padding: 15px; border-radius: 8px;">
            <h3 style="margin-top: 0; color: #f57c00; font-size: 16px;">รายละเอียดเหตุการณ์</h3>
            <table style="width: 100%; font-size: 14px; border-collapse: collapse;">
              ${statsRows || '<tr><td colspan="2" style="text-align: center; color: #666; padding: 10px;">ไม่มีข้อมูล</td></tr>'}
            </table>
          </div>
        </div>
      </div>

      ${bookmarks.length > 0 ? `
      <div style="margin-bottom: 20px;">
        <h2 style="color: #2e7d32; font-size: 20px;">⏱️ ไทม์ไลน์เหตุการณ์</h2>
        <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
          แสดงเหตุการณ์ทั้งหมด ${bookmarks.length} รายการ (ต่อในหน้าถัดไป)
        </p>
        <div style="background: #f0f8ff; padding: 15px; border-radius: 8px; border-left: 4px solid #2196f3;">
          <p style="margin: 0; color: #1565c0; font-weight: bold; font-size: 14px;">
            📋 รายละเอียดเหตุการณ์แยกตามหน้า ${Math.ceil(bookmarks.length / 15)} หน้า
          </p>
        </div>
      </div>
      ` : ''}

      <div style="position: absolute; bottom: 10mm; left: 0; right: 0; text-align: center; padding-top: 20px; border-top: 1px solid #ddd; color: #666; font-size: 12px;">
        สร้างโดย Football Time Tuner | หน้า 1
      </div>
    </div>
  `;
}

function createEventsHTML(pageBookmarks, pageNumber, totalPages, stats) {
  const eventsHtml = pageBookmarks.map(bookmark => {
    const eventType = EVENT_TYPES[bookmark.type];
    if (!eventType) return '';
    
    return `
      <tr style="border-bottom: 1px solid #eee;">
        <td style="text-align: center; padding: 12px 8px; border-right: 1px solid #ddd; width: 60px;">
          <span style="font-size: 20px;">${eventType.icon}</span>
        </td>
        <td style="padding: 12px 8px; border-right: 1px solid #ddd; font-weight: bold; width: 80px; font-size: 16px;">
          ${formatTimeForPDF(bookmark.time)}
        </td>
        <td style="padding: 12px 8px; border-right: 1px solid #ddd; width: 120px; font-size: 14px;">
          ${eventType.name}
        </td>
        <td style="padding: 12px 8px; font-size: 14px; word-break: break-word;">
          ${bookmark.note || '-'}
        </td>
      </tr>
    `;
  }).filter(row => row !== '').join('');

  return `
    <div style="
      font-family: 'Sarabun', 'Noto Sans Thai', 'Kanit', sans-serif;
      color: #333;
      line-height: 1.6;
      height: 267mm;
      overflow: hidden;
      padding: 10mm;
    ">
      <div style="border-bottom: 2px solid #4caf50; padding-bottom: 15px; margin-bottom: 20px;">
        <h1 style="color: #2e7d32; margin: 0; font-size: 24px; font-weight: bold;">
          ⏱️ ไทม์ไลน์เหตุการณ์ (หน้า ${pageNumber}/${totalPages})
        </h1>
        <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">
          แสดงเหตุการณ์ ${(pageNumber-1)*15 + 1} - ${Math.min(pageNumber*15, bookmarks.length)} จากทั้งหมด ${bookmarks.length} รายการ
        </p>
      </div>

      <div style="margin-bottom: 20px;">
        <table style="width: 100%; border-collapse: collapse; font-size: 14px; background: white; border: 1px solid #ddd;">
          <thead>
            <tr style="background: #4caf50; color: white;">
              <th style="padding: 15px 8px; text-align: center; font-size: 16px; font-weight: bold;">ไอคอน</th>
              <th style="padding: 15px 8px; text-align: center; font-size: 16px; font-weight: bold;">เวลา</th>
              <th style="padding: 15px 8px; text-align: center; font-size: 16px; font-weight: bold;">ประเภท</th>
              <th style="padding: 15px 8px; text-align: center; font-size: 16px; font-weight: bold;">หมายเหตุ</th>
            </tr>
          </thead>
          <tbody>
            ${eventsHtml}
          </tbody>
        </table>
      </div>

      <div style="position: absolute; bottom: 10mm; left: 0; right: 0; text-align: center; padding-top: 20px; border-top: 1px solid #ddd; color: #666; font-size: 12px;">
        สร้างโดย Football Time Tuner | หน้า ${pageNumber + 1} | ${stats.exportTime}
      </div>
    </div>
  `;
}

function updateLoadingMessage(loadingEl, message) {
  if (loadingEl) {
    const textNode = loadingEl.childNodes[1];
    if (textNode) {
      textNode.textContent = message;
    }
  }
}

function showSuccessMessage(message) {
  const successEl = document.createElement('div');
  successEl.textContent = message;
  successEl.style.cssText = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(76, 175, 80, 0.9);
    color: white;
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: bold;
    z-index: 1000;
    animation: fadeInOut 3s ease-in-out;
  `;
  document.body.appendChild(successEl);
  setTimeout(() => {
    if (document.body.contains(successEl)) {
      document.body.removeChild(successEl);
    }
  }, 3000);
}
function formatTimeForPDF(timeInSeconds) {
  const FIRST_HALF_MAX = getFirstHalfMaxSec();
  
  if (timeInSeconds <= 2700) {
    // First half (0-45:00)
    return fmtMMSS(timeInSeconds);
  } else if (timeInSeconds <= FIRST_HALF_MAX) {
    // First half extra time (45+0:01 to 45+end)
    const extraTime = timeInSeconds - 2700;
    const extraMinutes = Math.floor(extraTime / 60);
    const extraSeconds = Math.floor(extraTime % 60);
    return `45+${extraMinutes}:${pad2(extraSeconds)}`;
  } else if (timeInSeconds <= FIRST_HALF_MAX + 2700) {
    // Second half (45:01-90:00 equivalent)
    const secondHalfTime = timeInSeconds - FIRST_HALF_MAX;
    const totalMinutes = 45 + Math.floor(secondHalfTime / 60);
    const seconds = Math.floor(secondHalfTime % 60);
    return `${pad2(totalMinutes)}:${pad2(seconds)}`;
  } else {
    // Second half extra time (90+0:01 to 90+∞)
    const extraTime = timeInSeconds - (FIRST_HALF_MAX + 2700);
    const extraMinutes = Math.floor(extraTime / 60);
    const extraSeconds = Math.floor(extraTime % 60);
    return `90+${extraMinutes}:${pad2(extraSeconds)}`;
  }
}

// Generate score options for goal events
function generateScoreOptions() {
  const scores = [];
  for (let total = 0; total <= 20; total++) {
    for (let home = 0; home <= total; home++) {
      const away = total - home;
      if (away <= 10 && home <= 10) {
        scores.push(`(${home}–${away})`);
      }
    }
  }
  return scores;
}

// Generate important event options
function generateImportantOptions() {
  return [
    'OFR (onfield review)',
    'ONR (only review)'
  ];
}

// Update bookmark dropdown based on selected event type
function updateBookmarkDropdown(eventType) {
  const dropdown = elements.bookmarkDropdown;
  const noteInput = elements.bookmarkNote;
  const eventConfig = EVENT_TYPES[eventType];
  
  if (eventConfig.teamOptions) {
    // Show dropdown with team options
    dropdown.innerHTML = '<option value="">เลือกทีม</option>';
    eventConfig.teamOptions.forEach(team => {
      const option = document.createElement('option');
      option.value = team;
      option.textContent = team;
      dropdown.appendChild(option);
    });
    dropdown.style.display = 'block';
    noteInput.placeholder = 'หมายเหตุเพิ่มเติม (ไม่บังคับ)';
  } else if (eventConfig.scoreOptions) {
    // Show dropdown with score options
    dropdown.innerHTML = '<option value="">เลือกคะแนน</option>';
    generateScoreOptions().forEach(score => {
      const option = document.createElement('option');
      option.value = score;
      option.textContent = score;
      dropdown.appendChild(option);
    });
    dropdown.style.display = 'block';
    noteInput.placeholder = 'หมายเหตุเพิ่มเติม (ไม่บังคับ)';
  } else if (eventConfig.importantOptions) {
    // Show dropdown with important event options
    dropdown.innerHTML = '<option value="">เลือกประเภท</option>';
    generateImportantOptions().forEach(option => {
      const optionEl = document.createElement('option');
      optionEl.value = option;
      optionEl.textContent = option;
      dropdown.appendChild(optionEl);
    });
    dropdown.style.display = 'block';
    noteInput.placeholder = 'หมายเหตุเพิ่มเติม (ไม่บังคับ)';
  } else {
    // Hide dropdown for other event types
    dropdown.style.display = 'none';
    noteInput.placeholder = 'หมายเหตุ (ไม่บังคับ)';
  }
  
  // Reset dropdown value
  dropdown.value = '';
}

// Get combined note from dropdown and text input
function getCombinedNote() {
  const dropdownValue = elements.bookmarkDropdown.value;
  const noteValue = elements.bookmarkNote.value.trim();
  
  if (dropdownValue && noteValue) {
    return `${dropdownValue} - ${noteValue}`;
  } else if (dropdownValue) {
    return dropdownValue;
  } else {
    return noteValue;
  }
}

/* === Time calculation functions === */

function getStart1Sec() {
  return +elements.t1h.value * 3600 + +elements.t1m.value * 60;
}

function getStart2Sec() {
  return +elements.t2h.value * 3600 + +elements.t2m.value * 60;
}

function nowSecOfDay() {
  const d = new Date();
  return d.getHours() * 3600 + d.getMinutes() * 60 + d.getSeconds();
}

function secToHM(sec) {
  sec = ((sec % 86400) + 86400) % 86400;
  const h = Math.floor(sec / 3600);
  const m = Math.floor((sec % 3600) / 60);
  return `${pad2(h)}:${pad2(m)}`;
}

/* === Half End Management === */

function endFirstHalf() {
  firstHalfEndSec = seekSecVal;
  saveHalfEndTimes();
  updateHalfEndDisplay();
  
  // Show feedback
  const feedback = document.createElement('div');
  feedback.textContent = `⏹️ จบครึ่งแรกที่ ${formatTimeForPDF(firstHalfEndSec)}`;
  feedback.style.cssText = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(255, 152, 0, 0.9);
    color: white;
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: bold;
    z-index: 1000;
    animation: fadeInOut 3s ease-in-out;
  `;
  document.body.appendChild(feedback);
  setTimeout(() => {
    if (document.body.contains(feedback)) {
      document.body.removeChild(feedback);
    }
  }, 3000);
  
  // Rebuild ticks and bookmarks with new timeline
  buildTicks();
  renderBookmarks();
}

function endSecondHalf() {
  secondHalfEndSec = seekSecVal;
  saveHalfEndTimes();
  updateHalfEndDisplay();
  
  // Show feedback
  const feedback = document.createElement('div');
  feedback.textContent = `🏁 จบเกมที่ ${formatTimeForPDF(secondHalfEndSec)}`;
  feedback.style.cssText = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(76, 175, 80, 0.9);
    color: white;
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: bold;
    z-index: 1000;
    animation: fadeInOut 3s ease-in-out;
  `;
  document.body.appendChild(feedback);
  setTimeout(() => {
    if (document.body.contains(feedback)) {
      document.body.removeChild(feedback);
    }
  }, 3000);
  
  // Stop auto-play if running
  if (isAutoPlaying) {
    stopAutoPlay();
  }
}

function updateHalfEndDisplay() {
  // Update first half end display
  if (firstHalfEndSec !== null) {
    elements.firstHalfEndTime.textContent = formatTimeForPDF(firstHalfEndSec);
    elements.firstHalfEndTime.classList.add('set');
    elements.endFirstHalf.classList.add('completed');
    elements.endFirstHalf.textContent = '✅ ครึ่งแรกจบแล้ว';
    elements.resetFirstHalf.style.display = 'flex';
  } else {
    elements.firstHalfEndTime.textContent = '--:--';
    elements.firstHalfEndTime.classList.remove('set');
    elements.endFirstHalf.classList.remove('completed');
    elements.endFirstHalf.textContent = '⏹️ จบครึ่งแรก';
    elements.resetFirstHalf.style.display = 'none';
  }
  
  // Update second half end display
  if (secondHalfEndSec !== null) {
    elements.secondHalfEndTime.textContent = formatTimeForPDF(secondHalfEndSec);
    elements.secondHalfEndTime.classList.add('set');
    elements.endSecondHalf.classList.add('completed');
    elements.endSecondHalf.textContent = '🏆 เกมจบแล้ว';
    elements.resetSecondHalf.style.display = 'flex';
  } else {
    elements.secondHalfEndTime.textContent = '--:--';
    elements.secondHalfEndTime.classList.remove('set');
    elements.endSecondHalf.classList.remove('completed');
    elements.endSecondHalf.textContent = '🏁 จบเกม';
    elements.resetSecondHalf.style.display = 'none';
  }
}

function resetFirstHalf() {
  if (confirm('ต้องการรีเซ็ตเวลาจบครึ่งแรกหรือไม่?')) {
    firstHalfEndSec = null;
    
    // Remove from localStorage
    try {
      localStorage.removeItem(LS_KEYS.firstHalfEnd);
    } catch (e) {
      console.warn('Could not remove first half end time:', e);
    }
    
    updateHalfEndDisplay();
    
    // Show feedback
    const feedback = document.createElement('div');
    feedback.textContent = '🔄 รีเซ็ตเวลาจบครึ่งแรกแล้ว';
    feedback.style.cssText = `
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(33, 150, 243, 0.9);
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: bold;
      z-index: 1000;
      animation: fadeInOut 2s ease-in-out;
    `;
    document.body.appendChild(feedback);
    setTimeout(() => {
      if (document.body.contains(feedback)) {
        document.body.removeChild(feedback);
      }
    }, 2000);
    
    // Rebuild ticks and bookmarks
    buildTicks();
    renderBookmarks();
    render();
  }
}

function resetSecondHalf() {
  if (confirm('ต้องการรีเซ็ตเวลาจบเกมหรือไม่?')) {
    secondHalfEndSec = null;
    
    // Remove from localStorage
    try {
      localStorage.removeItem(LS_KEYS.secondHalfEnd);
    } catch (e) {
      console.warn('Could not remove second half end time:', e);
    }
    
    updateHalfEndDisplay();
    
    // Show feedback
    const feedback = document.createElement('div');
    feedback.textContent = '🔄 รีเซ็ตเวลาจบเกมแล้ว';
    feedback.style.cssText = `
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(33, 150, 243, 0.9);
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: bold;
      z-index: 1000;
      animation: fadeInOut 2s ease-in-out;
    `;
    document.body.appendChild(feedback);
    setTimeout(() => {
      if (document.body.contains(feedback)) {
        document.body.removeChild(feedback);
      }
    }, 2000);
    
    // Rebuild ticks and bookmarks
    buildTicks();
    renderBookmarks();
    render();
  }
}

function saveHalfEndTimes() {
  try {
    if (firstHalfEndSec !== null) {
      localStorage.setItem(LS_KEYS.firstHalfEnd, String(firstHalfEndSec));
    }
    if (secondHalfEndSec !== null) {
      localStorage.setItem(LS_KEYS.secondHalfEnd, String(secondHalfEndSec));
    }
  } catch (e) {
    console.warn('Could not save half end times:', e);
  }
}

function loadHalfEndTimes() {
  try {
    const firstEnd = localStorage.getItem(LS_KEYS.firstHalfEnd);
    const secondEnd = localStorage.getItem(LS_KEYS.secondHalfEnd);
    
    if (firstEnd !== null) {
      firstHalfEndSec = parseInt(firstEnd, 10);
    }
    if (secondEnd !== null) {
      secondHalfEndSec = parseInt(secondEnd, 10);
    }
    
    updateHalfEndDisplay();
    return (firstEnd !== null || secondEnd !== null);
  } catch (e) {
    console.warn('Could not load half end times:', e);
    return false;
  }
}

function getFirstHalfMaxSec() {
  // ถ้ากำหนดเวลาจบครึ่งแรกแล้ว ใช้เวลานั้น
  // ถ้าไม่ใช้ default 75 นาที (4500 วินาที)
  return firstHalfEndSec !== null ? firstHalfEndSec : 4500;
}

/* === Field time <-> Real time conversion === */

function fieldToRealSec(fieldSec) {
  if (start1Sec == null || start2Sec == null) return null;
  
  const FIRST_HALF_MAX = getFirstHalfMaxSec();
  
  // First half and its extra time
  if (fieldSec <= FIRST_HALF_MAX) {
    return start1Sec + fieldSec;
  }
  // Second half and its extra time  
  else {
    const secondHalfFieldTime = fieldSec - FIRST_HALF_MAX;
    return start2Sec + secondHalfFieldTime;
  }
}

function realToFieldSec(realSec) {
  if (start1Sec == null || start2Sec == null) return 0;
  
  const FIRST_HALF_MAX = getFirstHalfMaxSec();
  
  // First half period (including extra time)
  if (realSec >= start1Sec && realSec < start2Sec) {
    return Math.min(realSec - start1Sec, FIRST_HALF_MAX);
  }
  // Second half period (including extra time)
  else if (realSec >= start2Sec) {
    return FIRST_HALF_MAX + (realSec - start2Sec);
  }
  // Before first half
  else {
    return 0;
  }
}

/* === Auto-Play Functions === */

function startAutoPlay() {
  if (isAutoPlaying) return;
  
  isAutoPlaying = true;
  autoPlayStartTime = Date.now();
  autoPlayStartFieldTime = seekSecVal;
  
  elements.playBtn.textContent = '⏸️ Pause';
  elements.playBtn.classList.add('playing');
  
  autoPlayInterval = setInterval(updateAutoPlay, 100);
  
  updateAutoStatus();
}

function stopAutoPlay() {
  if (!isAutoPlaying) return;
  
  isAutoPlaying = false;
  autoPlayStartTime = null;
  
  if (autoPlayInterval) {
    clearInterval(autoPlayInterval);
    autoPlayInterval = null;
  }
  
  elements.playBtn.textContent = '▶️ Play';
  elements.playBtn.classList.remove('playing');
  
  updateAutoStatus();
}

function updateAutoPlay() {
  if (!isAutoPlaying || !autoPlayStartTime) return;
  
  const elapsedRealTime = (Date.now() - autoPlayStartTime) / 1000;
  const elapsedFieldTime = elapsedRealTime * playbackSpeed;
  
  const newSeekVal = autoPlayStartFieldTime + elapsedFieldTime;
  
  if (newSeekVal >= MAX_SEC) {
    seekSecVal = MAX_SEC;
    stopAutoPlay();
    render();
    return;
  }
  
  seekSecVal = Math.min(newSeekVal, MAX_SEC);
  render();
}

function updateAutoStatus() {
  if (!isAutoPlaying) {
    elements.autoStatus.textContent = 'Paused';
  } else {
    elements.autoStatus.textContent = 'Playing';
  }
}

function goToLiveTime() {
  const nowSec = nowSecOfDay();
  const liveFieldTime = realToFieldSec(nowSec);
  
  if (isAutoPlaying) {
    stopAutoPlay();
  }
  
  seekSecVal = Math.max(0, Math.min(liveFieldTime, MAX_SEC));
  render();
  
  startAutoPlay();
  
  const liveFeedback = document.createElement('div');
  liveFeedback.textContent = `🔴 นาที ${formatTimeForPDF(seekSecVal)}`;
  liveFeedback.style.cssText = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(33, 150, 243, 0.9);
    color: white;
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: bold;
    z-index: 1000;
    animation: fadeInOut 2s ease-in-out;
  `;
  document.body.appendChild(liveFeedback);
  setTimeout(() => document.body.removeChild(liveFeedback), 2000);
}

/* === Bookmark management functions === */

function saveBookmarks() {
  try {
    localStorage.setItem(BOOKMARK_STORAGE_KEY, JSON.stringify(bookmarks));
  } catch (e) {
    console.warn('Could not save bookmarks:', e);
  }
}

function loadBookmarks() {
  try {
    const saved = localStorage.getItem(BOOKMARK_STORAGE_KEY);
    if (saved) {
      bookmarks = JSON.parse(saved);
    }
  } catch (e) {
    console.warn('Could not load bookmarks:', e);
    bookmarks = [];
  }
}

function addBookmark(timeInSeconds, eventType, note = '') {
  const bookmark = {
    id: Date.now(),
    time: timeInSeconds,
    type: eventType,
    note: note.trim(),
    created: new Date().toISOString()
  };
  
  bookmarks.push(bookmark);
  bookmarks.sort((a, b) => a.time - b.time);
  saveBookmarks();
  renderBookmarks();
  updateBookmarkCount();
}

function removeBookmark(bookmarkId) {
  bookmarks = bookmarks.filter(b => b.id !== bookmarkId);
  saveBookmarks();
  renderBookmarks();
  updateBookmarkCount();
  renderBookmarkList();
}

function clearAllBookmarks() {
  if (bookmarks.length === 0) {
    alert('ไม่มีเหตุการณ์ให้ลบ');
    return;
  }
  
  if (confirm(`ต้องการลบเหตุการณ์ทั้งหมด ${bookmarks.length} รายการหรือไม่?\n\nการดำเนินการนี้ไม่สามารถยกเลิกได้`)) {
    bookmarks = [];
    saveBookmarks();
    renderBookmarks();
    updateBookmarkCount();
    renderBookmarkList();
    
    const clearedFeedback = document.createElement('div');
    clearedFeedback.textContent = '✅ ลบเหตุการณ์ทั้งหมดแล้ว';
    clearedFeedback.style.cssText = `
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(244, 67, 54, 0.9);
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: bold;
      z-index: 1000;
      animation: fadeInOut 2s ease-in-out;
    `;
    document.body.appendChild(clearedFeedback);
    setTimeout(() => document.body.removeChild(clearedFeedback), 2000);
  }
}

function getBookmarkAtTime(timeInSeconds) {
  return bookmarks.find(b => Math.abs(b.time - timeInSeconds) <= 5);
}

function updateBookmarkCount() {
  if (elements.bookmarkCount) {
    elements.bookmarkCount.textContent = bookmarks.length;
  }
}

function renderBookmarks() {
  const FIRST_HALF_MAX = getFirstHalfMaxSec();
  const totalWidth = FIRST_HALF_MAX * PX_PER_SEC;
  
  // Clear both timeline bookmarks
  elements.bookmarksFirstHalf.style.width = totalWidth + 'px';
  elements.bookmarksFirstHalf.innerHTML = '';
  elements.bookmarksSecondHalf.style.width = totalWidth + 'px';
  elements.bookmarksSecondHalf.innerHTML = '';
  
  bookmarks.forEach(bookmark => {
    const marker = document.createElement('div');
    marker.className = `bookmark-marker ${EVENT_TYPES[bookmark.type].class}`;
    marker.innerHTML = EVENT_TYPES[bookmark.type].icon;
    marker.title = `${formatTimeForPDF(bookmark.time)} - ${EVENT_TYPES[bookmark.type].name}${bookmark.note ? ': ' + bookmark.note : ''}`;
    
    marker.addEventListener('click', () => {
      addClickEffect(marker);
      seekToTime(bookmark.time);
    });
    
    if (bookmark.time <= FIRST_HALF_MAX) {
      // First half timeline
      const x = bookmark.time * PX_PER_SEC;
      marker.style.left = (x - 12) + 'px';
      marker.style.top = '33px';
      elements.bookmarksFirstHalf.appendChild(marker);
    } else {
      // Second half timeline
      const secondHalfTime = bookmark.time - FIRST_HALF_MAX;
      const x = secondHalfTime * PX_PER_SEC;
      marker.style.left = (x - 12) + 'px';
      marker.style.top = '33px';
      elements.bookmarksSecondHalf.appendChild(marker);
    }
  });
}

function renderBookmarkList() {
  if (!elements.bookmarkList) return;
  
  if (bookmarks.length === 0) {
    elements.bookmarkList.innerHTML = '<div class="bookmark-empty">ยังไม่มีเหตุการณ์ที่บันทึกไว้</div>';
    return;
  }
  
  elements.bookmarkList.innerHTML = bookmarks.map(bookmark => `
    <div class="bookmark-item">
      <div class="bookmark-info">
        <span class="event-icon">${EVENT_TYPES[bookmark.type].icon}</span>
        <div class="bookmark-details">
          <div class="bookmark-time">${formatTimeForPDF(bookmark.time)}</div>
          ${bookmark.note ? `<div class="bookmark-note">${bookmark.note}</div>` : ''}
        </div>
      </div>
      <div class="bookmark-actions">
        <button class="bookmark-goto btn-animate" onclick="goToBookmark(${bookmark.time})">ไป</button>
        <button class="bookmark-delete btn-animate" onclick="deleteBookmark(${bookmark.id})">ลบ</button>
      </div>
    </div>
  `).join('');
}

window.goToBookmark = function(time) {
  seekToTime(time);
  closeBookmarkListSheet();
};

window.deleteBookmark = function(id) {
  if (confirm('ต้องการลบเหตุการณ์นี้หรือไม่?')) {
    removeBookmark(id);
  }
};

function seekToTime(time) {
  if (isAutoPlaying) {
    stopAutoPlay();
  }
  
  seekSecVal = time;
  render();
}

function saveSeekPosition() {
  try {
    localStorage.setItem(LS_KEYS.seekPos, String(seekSecVal));
  } catch (e) {
    console.warn('Could not save seek position:', e);
  }
}

function loadSeekPosition() {
  try {
    const saved = localStorage.getItem(LS_KEYS.seekPos);
    if (saved !== null) {
      const position = parseInt(saved, 10);
      if (!isNaN(position) && position >= 0 && position <= MAX_SEC) {
        seekSecVal = position;
        return true;
      }
    }
  } catch (e) {
    console.warn('Could not load seek position:', e);
  }
  return false;
}

function saveStarts() {
  try {
    localStorage.setItem(LS_KEYS.t1h, String(elements.t1h.value));
    localStorage.setItem(LS_KEYS.t1m, String(elements.t1m.value));
    localStorage.setItem(LS_KEYS.t2h, String(elements.t2h.value));
    localStorage.setItem(LS_KEYS.t2m, String(elements.t2m.value));
  } catch (e) {
    console.warn('Could not save to localStorage:', e);
  }
}

function loadStarts() {
  try {
    const a = localStorage.getItem(LS_KEYS.t1h);
    const b = localStorage.getItem(LS_KEYS.t1m);
    const c = localStorage.getItem(LS_KEYS.t2h);
    const d = localStorage.getItem(LS_KEYS.t2m);
    
    if (a !== null) elements.t1h.value = a;
    if (b !== null) elements.t1m.value = b;
    if (c !== null) elements.t2h.value = c;
    if (d !== null) elements.t2m.value = d;
    
    const hasAllSavedTimes = (a && b && c && d) != null;
    return hasAllSavedTimes;
  } catch (e) {
    console.warn('Could not load from localStorage:', e);
    return false;
  }
}

function saveTeamNames() {
  try {
    const teamAEl = document.querySelector('#teamA');
    const teamBEl = document.querySelector('#teamB');
    
    if (teamAEl) {
      localStorage.setItem(LS_KEYS.teamA, teamAEl.value.trim());
    }
    
    if (teamBEl) {
      localStorage.setItem(LS_KEYS.teamB, teamBEl.value.trim());
    }
  } catch (e) {
    console.warn('Could not save team names:', e);
  }
}

function loadTeamNames() {
  try {
    const teamA = localStorage.getItem(LS_KEYS.teamA);
    const teamB = localStorage.getItem(LS_KEYS.teamB);
    
    const teamAEl = document.querySelector('#teamA');
    const teamBEl = document.querySelector('#teamB');
    
    if (teamA !== null && teamAEl) {
      teamAEl.value = teamA;
    }
    
    if (teamB !== null && teamBEl) {
      teamBEl.value = teamB;
    }
    
    const hasTeamNames = teamA && teamB;
    return hasTeamNames;
  } catch (e) {
    console.warn('Could not load team names:', e);
    return false;
  }
}

function setupTeamNameListeners() {
  const teamAEl = document.querySelector('#teamA');
  const teamBEl = document.querySelector('#teamB');
  
  if (teamAEl) {
    teamAEl.addEventListener('input', saveTeamNames);
    teamAEl.addEventListener('blur', saveTeamNames);
    teamAEl.addEventListener('change', saveTeamNames);
  }
  
  if (teamBEl) {
    teamBEl.addEventListener('input', saveTeamNames);
    teamBEl.addEventListener('blur', saveTeamNames);
    teamBEl.addEventListener('change', saveTeamNames);
  }
}

/* === UI Building functions === */

function fillSelect(el, max) {
  el.innerHTML = '';
  for (let i = 0; i <= max; i++) {
    const option = document.createElement('option');
    option.value = i;
    option.textContent = pad2(i);
    el.appendChild(option);
  }
}

function buildTicks() {
  const FIRST_HALF_MAX = getFirstHalfMaxSec();
  const totalWidth = FIRST_HALF_MAX * PX_PER_SEC;
  
  // Build first half ticks
  elements.ticksFirstHalf.style.width = totalWidth + 'px';
  elements.ticksFirstHalf.style.background = `
    linear-gradient(90deg, 
      rgba(76,175,80,.15) 0 ${2700 * PX_PER_SEC}px, 
      rgba(255,152,0,.15) ${2700 * PX_PER_SEC}px 100%
    )`;
  elements.ticksFirstHalf.innerHTML = '';
  
  // Build second half ticks
  elements.ticksSecondHalf.style.width = totalWidth + 'px';
  elements.ticksSecondHalf.style.background = `
    linear-gradient(90deg, 
      rgba(139,195,74,.15) 0 ${2700 * PX_PER_SEC}px,
      rgba(244,67,54,.15) ${2700 * PX_PER_SEC}px 100%
    )`;
  elements.ticksSecondHalf.innerHTML = '';
  
  // Create ticks for first half
  for (let s = 0; s <= FIRST_HALF_MAX; s += 60) {
    const x = s * PX_PER_SEC;
    const tick = document.createElement('div');
    const isMajor = (s % 300 === 0); // Major tick every 5 minutes
    
    tick.className = 'tick' + (isMajor ? ' major' : '');
    tick.style.left = x + 'px';
    
    if (isMajor) {
      const label = document.createElement('div');
      let labelText = '';
      let labelClass = '';
      
      if (s <= 2700) {
        const minutes = Math.floor(s / 60);
        labelText = `${minutes}'`;
        labelClass = 'gr';
      } else {
        const extraMinutes = Math.floor((s - 2700) / 60);
        labelText = `45+${extraMinutes}'`;
        labelClass = 'et1';
      }
      
      label.className = 'label ' + labelClass;
      label.textContent = labelText;
      tick.appendChild(label);
    }
    
    elements.ticksFirstHalf.appendChild(tick);
  }
  
  // Create ticks for second half
  for (let s = 0; s <= FIRST_HALF_MAX; s += 60) {
    const x = s * PX_PER_SEC;
    const tick = document.createElement('div');
    const isMajor = (s % 300 === 0); // Major tick every 5 minutes
    
    tick.className = 'tick' + (isMajor ? ' major' : '');
    tick.style.left = x + 'px';
    
    if (isMajor) {
      const label = document.createElement('div');
      let labelText = '';
      let labelClass = '';
      
      if (s <= 2700) {
        const minutes = 45 + Math.floor(s / 60);
        labelText = `${minutes}'`;
        labelClass = 'pu';
      } else {
        const extraMinutes = Math.floor((s - 2700) / 60);
        labelText = `90+${extraMinutes}'`;
        labelClass = 'et2';
      }
      
      label.className = 'label ' + labelClass;
      label.textContent = labelText;
      tick.appendChild(label);
    }
    
    elements.ticksSecondHalf.appendChild(tick);
  }
}

/* === Rendering function === */

function render() {
  const FIRST_HALF_MAX = getFirstHalfMaxSec();
  const containerWidth = elements.wrap.clientWidth;
  
  // Determine which half we're in
  const isFirstHalf = seekSecVal <= FIRST_HALF_MAX;
  const isSecondHalf = seekSecVal > FIRST_HALF_MAX;
  
  if (isFirstHalf) {
    // First half positioning
    const left = containerWidth / 2 - (seekSecVal * PX_PER_SEC);
    elements.scaleFirstHalf.style.transform = `translateX(${left}px)`;
    elements.scaleSecondHalf.style.transform = `translateX(${containerWidth / 2}px)`; // Reset second half
    
    // Update needle visibility
    elements.needleFirstHalf.classList.add('active');
    elements.needleFirstHalf.classList.remove('inactive');
    elements.needleSecondHalf.classList.add('inactive');
    elements.needleSecondHalf.classList.remove('active');
  } else {
    // Second half positioning
    const secondHalfTime = seekSecVal - FIRST_HALF_MAX;
    const left = containerWidth / 2 - (secondHalfTime * PX_PER_SEC);
    elements.scaleSecondHalf.style.transform = `translateX(${left}px)`;
    elements.scaleFirstHalf.style.transform = `translateX(${containerWidth / 2 - FIRST_HALF_MAX * PX_PER_SEC}px)`; // Show end of first half
    
    // Update needle visibility
    elements.needleSecondHalf.classList.add('active');
    elements.needleSecondHalf.classList.remove('inactive');
    elements.needleFirstHalf.classList.add('inactive');
    elements.needleFirstHalf.classList.remove('active');
  }
  
  // Update pill styling and display text
  const pill = elements.barFieldPill;
  pill.classList.remove('h1', 'h2', 'et1', 'et2');
  
  let displayText = '';
  
  if (seekSecVal <= 2700) {
    // First half (0-45:00)
    pill.classList.add('h1');
    displayText = fmtMMSS(seekSecVal);
  } else if (seekSecVal <= FIRST_HALF_MAX) {
    // First half extra time (45+0:01 to 45+end)
    pill.classList.add('et1');
    const extraTime = seekSecVal - 2700;
    const extraMinutes = Math.floor(extraTime / 60);
    const extraSeconds = Math.floor(extraTime % 60);
    displayText = `45+${extraMinutes}:${pad2(extraSeconds)}`;
  } else if (seekSecVal <= FIRST_HALF_MAX + 2700) {
    // Second half (45:01-90:00 equivalent)
    pill.classList.add('h2');
    const secondHalfTime = seekSecVal - FIRST_HALF_MAX;
    const totalMinutes = 45 + Math.floor(secondHalfTime / 60);
    const seconds = Math.floor(secondHalfTime % 60);
    displayText = `${pad2(totalMinutes)}:${pad2(seconds)}`;
  } else {
    // Second half extra time (90+0:01 to 90+∞)
    pill.classList.add('et2');
    const extraTime = seekSecVal - (FIRST_HALF_MAX + 2700);
    const extraMinutes = Math.floor(extraTime / 60);
    const extraSeconds = Math.floor(extraTime % 60);
    displayText = `90+${extraMinutes}:${pad2(extraSeconds)}`;
  }
  
  elements.barField.textContent = displayText;
  
  const realSec = fieldToRealSec(seekSecVal);
  elements.barReal.textContent = realSec == null ? '--:--' : secToHM(realSec);
  
  saveSeekPosition();
}

/* === Interaction handlers === */

function clamp(value, min, max) {
  return Math.max(min, Math.min(max, value));
}

function pxToSec(px) {
  return px / PX_PER_SEC;
}

function addClickEffect(button) {
  button.style.transform = 'scale(0.95)';
  setTimeout(() => {
    button.style.transform = '';
  }, 150);
}

/* === Event Listeners === */

elements.playBtn.addEventListener('click', () => {
  addClickEffect(elements.playBtn);
  
  if (isAutoPlaying) {
    stopAutoPlay();
  } else {
    startAutoPlay();
  }
});

elements.liveBtn.addEventListener('click', () => {
  addClickEffect(elements.liveBtn);
  goToLiveTime();
});

// Updated drag handling for dual timeline
elements.wrap.addEventListener('pointerdown', e => {
  if (isAutoPlaying) {
    stopAutoPlay();
  }
  
  dragging = true;
  lastX = e.clientX;
  elements.scaleFirstHalf.classList.add('dragging');
  elements.scaleSecondHalf.classList.add('dragging');
  elements.wrap.setPointerCapture(e.pointerId);
});

elements.wrap.addEventListener('pointermove', e => {
  if (!dragging) return;
  
  const dx = e.clientX - lastX;
  lastX = e.clientX;
  seekSecVal = clamp(seekSecVal - pxToSec(dx), 0, MAX_SEC);
  render();
});

elements.wrap.addEventListener('pointerup', e => {
  dragging = false;
  elements.scaleFirstHalf.classList.remove('dragging');
  elements.scaleSecondHalf.classList.remove('dragging');
  elements.wrap.releasePointerCapture(e.pointerId);
});

elements.wrap.addEventListener('pointercancel', () => {
  dragging = false;
  elements.scaleFirstHalf.classList.remove('dragging');
  elements.scaleSecondHalf.classList.remove('dragging');
});

elements.wrap.addEventListener('wheel', e => {
  e.preventDefault();
  
  if (isAutoPlaying) {
    stopAutoPlay();
  }
  
  const step = e.shiftKey ? 30 : 5;
  const direction = (e.deltaY > 0 || e.deltaX > 0) ? 1 : -1;
  seekSecVal = clamp(seekSecVal + direction * step, 0, MAX_SEC);
  render();
}, { passive: false });

window.addEventListener('keydown', e => {
  if (e.key === 'ArrowLeft') {
    if (isAutoPlaying) {
      stopAutoPlay();
    }
    seekSecVal = clamp(seekSecVal - (e.shiftKey ? 30 : 5), 0, MAX_SEC);
    render();
  }
  if (e.key === 'ArrowRight') {
    if (isAutoPlaying) {
      stopAutoPlay();
    }
    seekSecVal = clamp(seekSecVal + (e.shiftKey ? 30 : 5), 0, MAX_SEC);
    render();
  }
  if (e.key === ' ') {
    e.preventDefault();
    if (isAutoPlaying) {
      stopAutoPlay();
    } else {
      startAutoPlay();
    }
  }
});

/* === Bottom sheet (seek picker) === */

function openSheet() {
  elements.sheetMin.value = Math.floor(seekSecVal / 60);
  elements.sheetSec.value = Math.floor(seekSecVal % 60);
  elements.sheet.classList.add('open');
  elements.backdrop.classList.add('open');
}

function closeSheet() {
  elements.sheet.classList.remove('open');
  elements.backdrop.classList.remove('open');
}

/* === Bookmark sheet management === */

function openBookmarkSheet() {
  elements.bookmarkTime.textContent = formatTimeForPDF(seekSecVal);
  elements.bookmarkNote.value = '';
  elements.bookmarkDropdown.value = '';
  const yellowRadio = document.querySelector('input[name="eventType"][value="yellow"]');
  if (yellowRadio) yellowRadio.checked = true;
  
  // Update dropdown for default selection (yellow)
  updateBookmarkDropdown('yellow');
  
  elements.bookmarkSheet.classList.add('open');
  elements.bookmarkBackdrop.classList.add('open');
}

function closeBookmarkSheet() {
  elements.bookmarkSheet.classList.remove('open');
  elements.bookmarkBackdrop.classList.remove('open');
}

function openBookmarkListSheet() {
  renderBookmarkList();
  elements.bookmarkListSheet.classList.add('open');
  elements.bookmarkListBackdrop.classList.add('open');
}

function closeBookmarkListSheet() {
  elements.bookmarkListSheet.classList.remove('open');
  elements.bookmarkListBackdrop.classList.remove('open');
}

elements.barFieldPill.addEventListener('click', () => {
  addClickEffect(elements.barFieldPill);
  setTimeout(openSheet, 100);
});

elements.backdrop.addEventListener('click', closeSheet);

elements.sheetCancel.addEventListener('click', () => {
  addClickEffect(elements.sheetCancel);
  closeSheet();
});

elements.sheetGo.addEventListener('click', () => {
  addClickEffect(elements.sheetGo);
  const minutes = +elements.sheetMin.value || 0;
  const seconds = +elements.sheetSec.value || 0;
  const newTime = clamp(minutes * 60 + seconds, 0, MAX_SEC);
  seekToTime(newTime);
  closeSheet();
});

elements.quick0.addEventListener('click', () => {
  addClickEffect(elements.quick0);
  elements.sheetMin.value = 0;
  elements.sheetSec.value = 0;
  setTimeout(() => elements.sheetGo.click(), 100);
});

elements.quick45.addEventListener('click', () => {
  addClickEffect(elements.quick45);
  elements.sheetMin.value = 45;
  elements.sheetSec.value = 0;
  setTimeout(() => elements.sheetGo.click(), 100);
});

elements.quick90.addEventListener('click', () => {
  addClickEffect(elements.quick90);
  elements.sheetMin.value = 90;
  elements.sheetSec.value = 0;
  setTimeout(() => elements.sheetGo.click(), 100);
});

// Add quick buttons for extra time
const quick45plus5 = $('#quick45plus5');
const quick90plus5 = $('#quick90plus5');
const quick90plus10 = $('#quick90plus10');

if (quick45plus5) {
  quick45plus5.addEventListener('click', () => {
    addClickEffect(quick45plus5);
    // 45+5 = 2700 + 300 = 3000 seconds
    seekSecVal = 3000;
    render();
    closeSheet();
  });
}

if (quick90plus5) {
  quick90plus5.addEventListener('click', () => {
    addClickEffect(quick90plus5);
    // 90+5 = 4500 (first half max) + 2700 (second half) + 300 (5 minutes extra) = 7500 seconds  
    seekSecVal = 7500;
    render();
    closeSheet();
  });
}

if (quick90plus10) {
  quick90plus10.addEventListener('click', () => {
    addClickEffect(quick90plus10);
    // 90+10 = 4500 (first half max) + 2700 (second half) + 600 (10 minutes extra) = 7800 seconds  
    seekSecVal = 7800;
    render();
    closeSheet();
  });
}

/* === Bookmark event listeners === */

elements.addBookmarkBtn.addEventListener('click', () => {
  addClickEffect(elements.addBookmarkBtn);
  setTimeout(openBookmarkSheet, 100);
});

elements.viewBookmarksBtn.addEventListener('click', () => {
  addClickEffect(elements.viewBookmarksBtn);
  setTimeout(openBookmarkListSheet, 100);
});

elements.bookmarkBackdrop.addEventListener('click', closeBookmarkSheet);
elements.bookmarkCancel.addEventListener('click', () => {
  addClickEffect(elements.bookmarkCancel);
  closeBookmarkSheet();
});

elements.bookmarkSave.addEventListener('click', () => {
  addClickEffect(elements.bookmarkSave);
  
  const selectedType = document.querySelector('input[name="eventType"]:checked');
  if (!selectedType) return;
  
  const eventType = selectedType.value;
  const note = getCombinedNote(); // Use combined note from dropdown and text input
  
  const existingBookmark = getBookmarkAtTime(seekSecVal);
  if (existingBookmark) {
    if (!confirm('มีเหตุการณ์อยู่แล้วในเวลานี้ ต้องการเขียนทับหรือไม่?')) {
      return;
    }
    removeBookmark(existingBookmark.id);
  }
  
  addBookmark(seekSecVal, eventType, note);
  closeBookmarkSheet();
  
  const savedFeedback = document.createElement('div');
  savedFeedback.textContent = '✅ บันทึกเหตุการณ์แล้ว';
  savedFeedback.style.cssText = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(76, 175, 80, 0.9);
    color: white;
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: bold;
    z-index: 1000;
    animation: fadeInOut 2s ease-in-out;
  `;
  document.body.appendChild(savedFeedback);
  setTimeout(() => document.body.removeChild(savedFeedback), 2000);
});

// Add event listener for event type changes
document.addEventListener('change', (e) => {
  if (e.target.name === 'eventType') {
    updateBookmarkDropdown(e.target.value);
  }
});

elements.bookmarkListBackdrop.addEventListener('click', closeBookmarkListSheet);
elements.bookmarkListClose.addEventListener('click', () => {
  addClickEffect(elements.bookmarkListClose);
  closeBookmarkListSheet();
});

elements.clearAllBookmarks.addEventListener('click', () => {
  addClickEffect(elements.clearAllBookmarks);
  setTimeout(clearAllBookmarks, 100);
});

if (elements.exportBtn) {
  elements.exportBtn.addEventListener('click', () => {
    addClickEffect(elements.exportBtn);
    setTimeout(exportMatchToPDF, 100);
  });
}

/* === Start time controls === */

function syncStarts() {
  start1Sec = getStart1Sec();
  start2Sec = getStart2Sec();
  saveStarts();
  render();
}

[elements.t1h, elements.t1m, elements.t2h, elements.t2m].forEach(el => {
  if (el) el.addEventListener('change', syncStarts);
});

elements.t1now.addEventListener('click', () => {
  addClickEffect(elements.t1now);
  const now = new Date();
  elements.t1h.value = now.getHours();
  elements.t1m.value = now.getMinutes();
  syncStarts();
});

elements.t2now.addEventListener('click', () => {
  addClickEffect(elements.t2now);
  const now = new Date();
  elements.t2h.value = now.getHours();
  elements.t2m.value = now.getMinutes();
  syncStarts();
});

/* === Half End Event Listeners === */

elements.endFirstHalf.addEventListener('click', () => {
  addClickEffect(elements.endFirstHalf);
  if (firstHalfEndSec === null) {
    endFirstHalf();
  }
});

elements.endSecondHalf.addEventListener('click', () => {
  addClickEffect(elements.endSecondHalf);
  if (secondHalfEndSec === null) {
    endSecondHalf();
  }
});

elements.resetFirstHalf.addEventListener('click', () => {
  addClickEffect(elements.resetFirstHalf);
  resetFirstHalf();
});

elements.resetSecondHalf.addEventListener('click', () => {
  addClickEffect(elements.resetSecondHalf);
  resetSecondHalf();
});

/* === Initialization === */

function init() {
  fillSelect(elements.t1h, 23);
  fillSelect(elements.t2h, 23);
  fillSelect(elements.t1m, 59);
  fillSelect(elements.t2m, 59);
  
  fillSelect(elements.sheetMin, 150); // Extended to 150 minutes for unlimited extra time
  fillSelect(elements.sheetSec, 59);
  
  setupTeamNameListeners();
  
  const hadSavedTimes = loadStarts();
  const hadSavedTeams = loadTeamNames();
  const hadSavedHalfEnds = loadHalfEndTimes();
  
  if (!hadSavedTimes) {
    const now = new Date();
    elements.t1h.value = now.getHours();
    elements.t1m.value = now.getMinutes();
    
    const secondHalfStart = new Date(now.getTime() + 55 * 60000);
    elements.t2h.value = secondHalfStart.getHours();
    elements.t2m.value = secondHalfStart.getMinutes();
  }
  
  loadBookmarks();
  updateBookmarkCount();
  
  buildTicks();
  syncStarts();
  
  const hadSavedPosition = loadSeekPosition();
  if (!hadSavedPosition) {
    seekSecVal = 0;
  }
  
  render();
  renderBookmarks();
  
  updateAutoStatus();
  
  if (hadSavedTimes || hadSavedPosition || bookmarks.length > 0 || hadSavedTeams || hadSavedHalfEnds) {
    const restoredItems = [];
    if (hadSavedTimes) restoredItems.push('เวลาเริ่มแมตช์');
    if (hadSavedPosition) restoredItems.push('ตำแหน่งเวลา');
    if (bookmarks.length > 0) restoredItems.push(`เหตุการณ์ ${bookmarks.length} รายการ`);
    if (hadSavedTeams) restoredItems.push('ชื่อทีม');
    if (hadSavedHalfEnds) restoredItems.push('เวลาจบครึ่ง');
    
    const restoredFeedback = document.createElement('div');
    restoredFeedback.textContent = `✅ กู้คืนข้อมูล: ${restoredItems.join(', ')}`;
    restoredFeedback.style.cssText = `
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(76, 175, 80, 0.9);
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: bold;
      z-index: 1000;
      animation: fadeInOut 3s ease-in-out;
      font-size: 14px;
    `;
    document.body.appendChild(restoredFeedback);
    setTimeout(() => {
      if (document.body.contains(restoredFeedback)) {
        document.body.removeChild(restoredFeedback);
      }
    }, 3000);
  }
}

window.addEventListener('resize', render);

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}

setInterval(() => {
  if (start1Sec !== null && start2Sec !== null) {
    const realSec = fieldToRealSec(seekSecVal);
    if (realSec !== null) {
      elements.barReal.textContent = secToHM(realSec);
    }
  }
}, 1000);
</script>

</body>
</html>
